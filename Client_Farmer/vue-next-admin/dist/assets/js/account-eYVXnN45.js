import{l as S,v as $,s as A,u as E,Z as j,M as z,p as O,A as r,a5 as H,B as _,C as w,D as n,H as t,P as k,Q as J,F as y,S as L,T as x,e as m}from"./.store-B6_YEv0p.js";import{u as Q,b as Z,d as G,S as h,i as K,k as W}from"./index-LdrvTkjS.js";import{a as X}from"./formatTime-in1fXasu.js";import{l as Y}from"./auth-CGWu7Q6W.js";import{f as ee}from"./farm-DMiypgV0.js";import{_ as oe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const se=S({name:"loginAccount"}),ne=S({...se,setup(te){const{t:T}=$.useI18n(),V=Q(),{themeConfig:P}=A(V),I=Z(),U=G(),d=E(),f=j(),e=z({isShowPassword:!1,ruleForm:{userName:"",password:"",code:"1234"},verificationCode:"1234",loading:{signIn:!1}}),b=O(()=>X(new Date)),N=()=>Math.floor(1e3+Math.random()*9e3).toString(),R=()=>{e.verificationCode=N(),e.ruleForm.code=""},B=async()=>{try{const s=I.getUserInfo;if(!s||!s.admin_id){console.error("用户信息不完整，跳过农场绑定检查");return}const o={admin_id:s.admin_id};console.log("登录后检查农场绑定状态...");const a=await ee(o);if(console.log("农场绑定检查响应:",a.code,a.msg||a.Msg),a.code===200){const l=a.farm||a.Farm;h.set("farmInfo",l),console.log("用户已绑定农场，农场信息已保存到缓存")}else a.code===10001?(console.log("用户尚未绑定农场，将跳转到绑定页面"),setTimeout(()=>{f.push("/tools"),m.warning("检测到您尚未绑定农场，请先完成农场绑定！")},1e3)):console.error("检查农场绑定状态失败:",a.msg||a.Msg)}catch(s){console.error("检查农场绑定状态异常:",s.message||s)}},D=async()=>{if(e.ruleForm.code!==e.verificationCode){m.error("验证码错误，请重新输入");return}if(!e.ruleForm.userName||!e.ruleForm.password){m.error("请输入手机号和密码");return}e.loading.signIn=!0;try{const s={phone_number:e.ruleForm.userName,password:e.ruleForm.password};console.log("发送登录请求数据:",s);const o=await Y(s);o.code===200?(I.setLoginInfo(o),await U.setUserInfos(),h.set("token",o.accessToken),console.log("保存的token:",o.accessToken),console.log("验证token是否保存成功:",h.get("token")),await B(),P.value.isRequestRoutes?(await W(),C(!1)):(await K(),C(!1))):(m.error(o.msg||"登录失败"),e.loading.signIn=!1)}catch(s){console.error("登录请求失败:",s),m.error("网络错误，请稍后重试"),e.loading.signIn=!1}},C=s=>{var o,a,l,i;{let c=b.value;(o=d.query)!=null&&o.redirect?f.push({path:(a=d.query)==null?void 0:a.redirect,query:Object.keys((l=d.query)==null?void 0:l.params).length>0?JSON.parse((i=d.query)==null?void 0:i.params):""}):(console.log("准备跳转到首页"),f.push("/"));const p=T("message.signInText");m.success(`${c}，${p}`)}e.loading.signIn=!1};return(s,o)=>{const a=r("ele-User"),l=r("el-icon"),i=r("el-input"),c=r("el-form-item"),p=r("ele-Unlock"),q=r("ele-Position"),g=r("el-col"),v=r("el-button"),M=r("el-form"),F=H("waves");return w(),_(M,{size:"large",class:"login-content-form"},{default:n(()=>[t(c,{class:"login-animation1"},{default:n(()=>[t(i,{text:"",placeholder:"请输入手机号",modelValue:e.ruleForm.userName,"onUpdate:modelValue":o[0]||(o[0]=u=>e.ruleForm.userName=u),clearable:"",autocomplete:"off"},{prefix:n(()=>[t(l,{class:"el-input__icon"},{default:n(()=>[t(a)]),_:1})]),_:1},8,["modelValue"])]),_:1}),t(c,{class:"login-animation2"},{default:n(()=>[t(i,{type:e.isShowPassword?"text":"password",placeholder:s.$t("message.account.accountPlaceholder2"),modelValue:e.ruleForm.password,"onUpdate:modelValue":o[2]||(o[2]=u=>e.ruleForm.password=u),autocomplete:"off"},{prefix:n(()=>[t(l,{class:"el-input__icon"},{default:n(()=>[t(p)]),_:1})]),suffix:n(()=>[k("i",{class:J(["iconfont el-input__icon login-content-password",e.isShowPassword?"icon-yincangmima":"icon-xianshimima"]),onClick:o[1]||(o[1]=u=>e.isShowPassword=!e.isShowPassword)},null,2)]),_:1},8,["type","placeholder","modelValue"])]),_:1}),t(c,{class:"login-animation3"},{default:n(()=>[t(g,{span:15},{default:n(()=>[t(i,{text:"",maxlength:"4",placeholder:s.$t("message.account.accountPlaceholder3"),modelValue:e.ruleForm.code,"onUpdate:modelValue":o[3]||(o[3]=u=>e.ruleForm.code=u),clearable:"",autocomplete:"off"},{prefix:n(()=>[t(l,{class:"el-input__icon"},{default:n(()=>[t(q)]),_:1})]),_:1},8,["placeholder","modelValue"])]),_:1}),t(g,{span:1}),t(g,{span:8},{default:n(()=>[y((w(),_(v,{class:"login-content-code",onClick:R},{default:n(()=>[L(x(e.verificationCode),1)]),_:1})),[[F]])]),_:1})]),_:1}),t(c,{class:"login-animation4"},{default:n(()=>[y((w(),_(v,{type:"primary",class:"login-content-submit",round:"",onClick:D,loading:e.loading.signIn},{default:n(()=>[k("span",null,x(s.$t("message.account.accountBtnText")),1)]),_:1},8,["loading"])),[[F]])]),_:1})]),_:1})}}}),me=oe(ne,[["__scopeId","data-v-4b0c73db"]]);export{me as default};
