import{l as N,r as L,M as V,y as B,w as U,n as H,A as f,a5 as P,O,C as D,P as o,H as n,D as i,S,$ as j,a0 as W,B as z,T as y,F as q,e as _,a2 as J}from"./.store-DdqHRk86.js";import{b as K,S as Q}from"./index-uJp-ZfSa.js";import{b as X}from"./farm-DDGW1gtK.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"land-analysis-container layout-pd"},te={class:"time-selector mb15"},ae={class:"time-buttons"},oe={class:"time-info"},re={class:"card-content"},se={class:"card-info"},le={class:"card-value"},ne=["innerHTML"],ie={class:"card-content"},de={class:"card-info"},ce={class:"card-value"},pe={class:"card-content"},ve={class:"card-info"},ge={class:"card-value"},ue={class:"card-content"},me={class:"card-info"},fe={class:"card-value"},we={class:"pagination-container"},_e=N({name:"landAnalysis"}),ye=N({..._e,setup(he){const A=K(),x=L(),e=V({activeTimeType:"year",selectedTime:"",timeOptions:[],loading:!1,overview:{totalOrders:0,totalSales:0,avgOrderValue:0,activeDays:0,ordersGrowth:"",salesGrowth:"",avgGrowth:"",daysGrowth:""},tableData:[],allData:[],pagination:{page:1,size:20,total:0},chart:null}),F=()=>{const r=A.getUserInfo,t=Q.get("farmInfo");let a=0;return t!=null&&t.farm_id?a=t.farm_id:r!=null&&r.farm_id&&(a=r.farm_id),a},h=(r,t)=>{if(t===0)return r>0?'环比增长率：<span style="color: #F56C6C;">+∞%</span>':'环比增长率：<span style="color: #909399;">0%</span>';const a=(r/t-1)*100,s=Math.abs(a).toFixed(1);return a>0?`环比增长率：<span style="color: #F56C6C;">+${s}%</span>`:a<0?`环比增长率：<span style="color: #67C23A;">-${s}%</span>`:'环比增长率：<span style="color: #909399;">0%</span>'},k=r=>{console.log("生成时间选项，类型:",r);const a=new Date().getFullYear(),s=[];switch(r){case"year":for(let c=2025;c<=a;c++)s.push({value:c.toString(),label:`${c}年`});break;case"month":for(let c=1;c<=12;c++){const u=c.toString().padStart(2,"0");s.push({value:`${a}-${u}`,label:`${a}年${c}月`})}break;case"week":const p=new Date(a,0,1);let l=new Date(p);for(;l.getDay()!==1;)l.setDate(l.getDate()-1);let d=1;const m=52;for(;d<=m;){const c=new Date(l),u=new Date(l);if(u.setDate(c.getDate()+6),u.getFullYear()>a)break;const w=`${c.getFullYear()}-${(c.getMonth()+1).toString().padStart(2,"0")}-${c.getDate().toString().padStart(2,"0")}`,g=`${u.getFullYear()}-${(u.getMonth()+1).toString().padStart(2,"0")}-${u.getDate().toString().padStart(2,"0")}`;s.push({value:`${w}|${g}`,label:`${c.getMonth()+1}月${c.getDate()}日-${u.getMonth()+1}月${u.getDate()}日（第${d}周）`}),l.setDate(l.getDate()+7),d++}console.log("生成的周选项数量:",s.length);break}return s},G=(r,t)=>{let a="",s="";console.log("getTimeRange 输入:",{type:r,selectedValue:t});try{switch(r){case"year":const v=parseInt(t);if(isNaN(v))throw new Error("年份格式无效");a=`${v}-01-01`,s=`${v}-12-31`;break;case"month":const[p,l]=t.split("-"),d=parseInt(p),m=parseInt(l);if(isNaN(d)||isNaN(m))throw new Error("月份格式无效");a=`${d}-${l}-01`;const c=new Date(d,m,0).getDate();s=`${d}-${l}-${c.toString().padStart(2,"0")}`;break;case"week":if(!t||!t.includes("|"))throw new Error("周格式无效");const[u,w]=t.split("|");if(!u||!w)throw new Error("周日期范围无效");a=u,s=w;break;default:throw new Error("未知的时间类型")}}catch(v){console.error("时间范围计算错误:",v);const p=new Date,l=p.getFullYear(),d=(p.getMonth()+1).toString().padStart(2,"0"),m=p.getDate().toString().padStart(2,"0");a=`${l}-${d}-${m}`,s=`${l}-${d}-${m}`}return console.log("getTimeRange 输出:",{startDate:a,endDate:s}),{startDate:a,endDate:s}},T=async()=>{try{e.loading=!0;const r=F();if(!r){_.error("未找到农场信息，请先绑定农场");return}if(!e.selectedTime){_.error("请选择查看时间");return}console.log("选中的时间:",e.selectedTime),console.log("时间类型:",e.activeTimeType);const t=G(e.activeTimeType,e.selectedTime);if(console.log("计算的时间范围:",t),!t.startDate||!t.endDate){_.error("时间范围计算错误，请重新选择");return}const a={farm_id:r,start_date:t.startDate,end_date:t.endDate};console.log("请求参数:",a);const s=await X(a);s.code===200?(e.allData=s.sale_data||[],I(e.allData),b(),C()):_.error(`获取数据失败: ${s.msg}`)}catch(r){console.error("获取销售数据失败:",r),_.error("获取数据失败，请稍后重试")}finally{e.loading=!1}},I=(r=[])=>{const t=e.allData;if(e.overview.totalOrders=t.reduce((a,s)=>a+s.land_order_count,0),e.overview.totalSales=t.reduce((a,s)=>a+s.land_sale_count,0),e.overview.avgOrderValue=e.overview.totalOrders>0?e.overview.totalSales/e.overview.totalOrders:0,e.overview.activeDays=t.filter(a=>a.land_order_count>0).length,r.length>0){const a=r.reduce((l,d)=>l+d.land_order_count,0),s=r.reduce((l,d)=>l+d.land_sale_count,0),v=a>0?s/a:0,p=r.filter(l=>l.land_order_count>0).length;e.overview.ordersGrowth=h(e.overview.totalOrders,a),e.overview.salesGrowth=h(e.overview.totalSales,s),e.overview.avgGrowth=h(e.overview.avgOrderValue,v),e.overview.daysGrowth=h(e.overview.activeDays,p)}else e.overview.ordersGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.salesGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.avgGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.daysGrowth='环比增长率：<span style="color: #909399;">N/A</span>'},b=()=>{const r=(e.pagination.page-1)*e.pagination.size,t=r+e.pagination.size;e.tableData=e.allData.slice(r,t),e.pagination.total=e.allData.length},M=()=>{x.value&&(e.chart=J(x.value),C())},C=()=>{if(!e.chart)return;const r=e.allData.map(v=>v.stat_date),t=e.allData.map(v=>v.land_order_count),a=e.allData.map(v=>v.land_sale_count),s={title:{text:"土地租赁趋势",left:"center",textStyle:{fontSize:16}},tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["租赁订单数量","租赁销售金额"],top:30},grid:{top:70,left:50,right:50,bottom:50},xAxis:{type:"category",data:r,axisLabel:{rotate:45,fontSize:10}},yAxis:[{type:"value",name:"订单数量",position:"left",axisLabel:{formatter:"{value}"}},{type:"value",name:"销售金额",position:"right",axisLabel:{formatter:"¥{value}"}}],series:[{name:"租赁订单数量",type:"bar",yAxisIndex:0,data:t,itemStyle:{color:"#E6A23C"}},{name:"租赁销售金额",type:"line",yAxisIndex:1,data:a,smooth:!0,itemStyle:{color:"#F56C6C"},lineStyle:{color:"#F56C6C"}}]};e.chart.setOption(s)},$=r=>{if(console.log("切换时间类型到:",r),e.activeTimeType=r,e.timeOptions=k(r),console.log("生成的时间选项:",e.timeOptions),e.timeOptions.length>0)e.selectedTime=e.timeOptions[0].value,console.log("默认选择的时间:",e.selectedTime);else{console.error("没有生成时间选项"),_.error("无法生成时间选项，请刷新页面重试");return}e.pagination.page=1,T()},E=()=>{e.pagination.page=1,T()},R=r=>{e.pagination.size=r,e.pagination.page=1,b()},Y=r=>{e.pagination.page=r,b()};return B(()=>e.allData,()=>{b()}),U(()=>{e.timeOptions=k(e.activeTimeType),e.timeOptions.length>0&&(e.selectedTime=e.timeOptions[0].value),H(()=>{M(),T()})}),(r,t)=>{const a=f("el-button"),s=f("el-option"),v=f("el-select"),p=f("el-card"),l=f("el-col"),d=f("el-row"),m=f("el-table-column"),c=f("el-table"),u=f("el-pagination"),w=P("loading");return D(),O("div",ee,[t[20]||(t[20]=o("div",{class:"page-header mb15"},[o("h2",null,"土地数据分析"),o("p",null,"查看土地订单数据的详细统计和趋势分析")],-1)),o("div",te,[n(p,{class:"time-selector-card"},{default:i(()=>[o("div",ae,[n(a,{type:e.activeTimeType==="year"?"primary":"default",onClick:t[0]||(t[0]=g=>$("year")),size:"large"},{default:i(()=>[...t[6]||(t[6]=[S(" 年总结 ",-1)])]),_:1},8,["type"]),n(a,{type:e.activeTimeType==="month"?"primary":"default",onClick:t[1]||(t[1]=g=>$("month")),size:"large"},{default:i(()=>[...t[7]||(t[7]=[S(" 月总结 ",-1)])]),_:1},8,["type"]),n(a,{type:e.activeTimeType==="week"?"primary":"default",onClick:t[2]||(t[2]=g=>$("week")),size:"large"},{default:i(()=>[...t[8]||(t[8]=[S(" 周总结 ",-1)])]),_:1},8,["type"])]),o("div",oe,[t[9]||(t[9]=o("span",{class:"time-label"},"当前查看：",-1)),n(v,{modelValue:e.selectedTime,"onUpdate:modelValue":t[3]||(t[3]=g=>e.selectedTime=g),onChange:E,style:{width:"200px"},placeholder:"请选择时间"},{default:i(()=>[(D(!0),O(j,null,W(e.timeOptions,g=>(D(),z(s,{key:g.value,label:g.label,value:g.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),_:1})]),n(d,{gutter:15,class:"overview-cards mb15"},{default:i(()=>[n(l,{xs:24,sm:12,md:12,xl:12},{default:i(()=>[n(p,{class:"overview-card"},{default:i(()=>[o("div",re,[t[11]||(t[11]=o("div",{class:"card-icon",style:{background:"var(--next-color-primary-lighter)"}},[o("i",{class:"fa fa-map",style:{color:"var(--el-color-primary)"}})],-1)),o("div",se,[o("div",le,y(e.overview.totalOrders),1),t[10]||(t[10]=o("div",{class:"card-label"},"总订单数",-1)),o("div",{class:"card-growth",innerHTML:e.overview.ordersGrowth},null,8,ne)])])]),_:1})]),_:1}),n(l,{xs:24,sm:12,md:12,xl:12},{default:i(()=>[n(p,{class:"overview-card"},{default:i(()=>[o("div",ie,[t[13]||(t[13]=o("div",{class:"card-icon",style:{background:"var(--next-color-success-lighter)"}},[o("i",{class:"fa fa-dollar",style:{color:"var(--el-color-success)"}})],-1)),o("div",de,[o("div",ce,"¥"+y(e.overview.totalSales.toFixed(2)),1),t[12]||(t[12]=o("div",{class:"card-label"},"总销售额",-1))])])]),_:1})]),_:1})]),_:1}),n(d,{gutter:15,class:"overview-cards mb15"},{default:i(()=>[n(l,{xs:24,sm:12,md:12,xl:12},{default:i(()=>[n(p,{class:"overview-card"},{default:i(()=>[o("div",pe,[t[15]||(t[15]=o("div",{class:"card-icon",style:{background:"var(--next-color-warning-lighter)"}},[o("i",{class:"fa fa-dollar",style:{color:"var(--el-color-warning)"}})],-1)),o("div",ve,[o("div",ge,"¥"+y(e.overview.avgOrderValue.toFixed(2)),1),t[14]||(t[14]=o("div",{class:"card-label"},"平均订单金额",-1))])])]),_:1})]),_:1}),n(l,{xs:24,sm:12,md:12,xl:12},{default:i(()=>[n(p,{class:"overview-card"},{default:i(()=>[o("div",ue,[t[17]||(t[17]=o("div",{class:"card-icon",style:{background:"var(--next-color-danger-lighter)"}},[o("i",{class:"fa fa-calendar",style:{color:"var(--el-color-danger)"}})],-1)),o("div",me,[o("div",fe,y(e.overview.activeDays),1),t[16]||(t[16]=o("div",{class:"card-label"},"活跃天数",-1))])])]),_:1})]),_:1})]),_:1}),n(d,{class:"mb15"},{default:i(()=>[n(l,{span:24},{default:i(()=>[n(p,{class:"chart-card"},{header:i(()=>[...t[18]||(t[18]=[o("div",{class:"card-header"},[o("span",null,"土地租赁趋势图表")],-1)])]),default:i(()=>[o("div",{ref_key:"chartRef",ref:x,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1}),n(d,null,{default:i(()=>[n(l,{span:24},{default:i(()=>[n(p,{class:"table-card"},{header:i(()=>[...t[19]||(t[19]=[o("div",{class:"card-header"},[o("span",null,"详细数据列表")],-1)])]),default:i(()=>[q((D(),z(c,{data:e.tableData,style:{width:"100%"},"max-height":"320"},{default:i(()=>[n(m,{prop:"stat_date",label:"日期",width:"100"}),n(m,{prop:"land_order_count",label:"订单数",width:"80",align:"center"}),n(m,{prop:"land_sale_count",label:"销售额",align:"center"},{default:i(g=>[S(" ¥"+y(g.row.land_sale_count.toFixed(2)),1)]),_:1})]),_:1},8,["data"])),[[w,e.loading]]),o("div",we,[n(u,{"current-page":e.pagination.page,"onUpdate:currentPage":t[4]||(t[4]=g=>e.pagination.page=g),"page-size":e.pagination.size,"onUpdate:pageSize":t[5]||(t[5]=g=>e.pagination.size=g),"page-sizes":[10,20,50,100],total:e.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:R,onCurrentChange:Y},null,8,["current-page","page-size","total"])])]),_:1})]),_:1})]),_:1})])}}}),Te=Z(ye,[["__scopeId","data-v-2b59110f"]]);export{Te as default};
