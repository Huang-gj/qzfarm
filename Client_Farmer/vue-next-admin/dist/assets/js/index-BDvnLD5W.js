import{s as U,d as de,S as ce}from"./index-Bt6IFO1h.js";import{u as ue,a as me}from"./test-C0kB_yHp.js";import{l as ve,r as c,M as pe,w as _e,A as u,a5 as fe,O as y,C as f,P as o,H as l,F as ge,D as a,S as w,G as C,$ as j,a0 as E,T as I,B as O,Q as ye,e as d}from"./.store-D3f7YvtR.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";function we(D){return U({url:"/api/GetMainPic",method:"post",data:{farm_id:D}})}function De(D){return U({url:"/api/GetActivityDetail",method:"post",data:{activity_id:D}})}function xe(D){return U({url:"/api/AddActivity",method:"post",data:{activity:D}})}const Pe={class:"activity-management-container layout-padding"},Ve={class:"activity-management-padding layout-padding-auto layout-padding-view"},Ie={class:"activity-management-header mb15"},be={class:"activity-grid"},ke=["onClick"],Ae={class:"activity-image"},Me={class:"image-slot"},Ce={class:"activity-info"},Ye={class:"activity-title"},Fe={key:0,class:"empty-state"},Re={key:0,class:"activity-detail"},Ue={class:"detail-header"},Be={class:"time-info"},He={key:0,class:"detail-images"},Ne={class:"image-grid"},$e={class:"image-slot"},ze={class:"detail-content"},Se={class:"content-text"},qe={class:"dialog-footer"},Ge=ve({__name:"index",setup(D){const T=de(),B=()=>{const t=ce.get("farmInfo");if(t){const i=t.farm_id||t.FarmID||t.farmId||t.id||t.ID;if(i&&i!==0)return i}const e=T.getUserInfo;if(e){const i=e.farm_id||e.FarmID||e.farmId;if(i&&i!==0)return i}return null},b=c(!1),k=c([]),Y=c(!1),V=c(!1),p=c(null),F=c(!1),A=c(),r=pe({title:"",main_pic:"",start_time:"",end_time:"",text:""}),J={title:[{required:!0,message:"请输入活动标题",trigger:"blur"}],start_time:[{required:!0,message:"请选择开始时间",trigger:"change"}],end_time:[{required:!0,message:"请选择结束时间",trigger:"change"}],text:[{required:!0,message:"请输入活动详情",trigger:"blur"}]},Q=c(),K=c(),g=c([]),H=c([]),h=c(null),x=c([]),N=t=>t?new Date(t).toLocaleString("zh-CN"):"-",R=async()=>{try{b.value=!0;const t=B();if(!t){d.error("未找到农场信息，请先绑定农场");return}const e=await we(t);if(console.log("GetMainPic接口响应:",e),e.code===0||e.code===200){const i=e.activity_ids||[],s=e.main_pics||[],m=e.title||[];console.log("activity_ids数组:",i),console.log("main_pics数组:",s),console.log("title数组:",m);const _=[];for(let v=0;v<i.length;v++)i[v]&&s[v]&&_.push({main_pic:s[v],title:m[v]||`活动 ${v+1}`,activity_id:i[v]});k.value=_,console.log("处理后的activityList:",k.value)}else d.error(e.msg||"获取活动列表失败")}catch(t){console.error("获取活动列表失败:",t),d.error("获取活动列表失败")}finally{b.value=!1}},W=async(t,e)=>{try{const i=t.activity_id;if(!i){d.error("无效的活动ID"),console.error("activity_id不存在:",t);return}console.log("查看活动详情，使用activity_id:",i,"item:",t);const s=await De(i);s.code===0||s.code===200?(p.value=s.activities,Y.value=!0):d.error(s.msg||"获取活动详情失败")}catch(i){console.error("获取活动详情失败:",i),d.error("获取活动详情失败")}},X=()=>{R()},$=()=>{V.value=!0,Z()},Z=()=>{var t;(t=A.value)==null||t.resetFields(),g.value=[],H.value=[],h.value=null,x.value=[],Object.assign(r,{title:"",main_pic:"",start_time:"",end_time:"",text:""})},ee=t=>g.value.length>=1?(d.error("主图只能上传一张"),!1):!0,te=(t,e)=>{e.length>1&&(e.splice(0,e.length-1),d.error("主图只能上传一张")),g.value=e,t.raw&&e.length===1&&(h.value=t.raw,r.main_pic=t.name)},le=(t,e)=>{g.value=e,h.value=null,r.main_pic=""},ie=(t,e)=>{x.value=e.map(i=>i.raw).filter(Boolean)},ae=(t,e)=>{x.value=e.map(i=>i.raw).filter(Boolean)},oe=async()=>{if(A.value)try{if(await A.value.validate(),!h.value){d.error("请上传主图片");return}if(g.value.length>1){d.error("主图只能有一张");return}const t=B();if(!t){d.error("未找到农场信息，请先绑定农场");return}const e=Number(t);console.log("farmId原始值:",t,"转换后:",e),F.value=!0;const i={activity_id:0,farm_id:e,main_pic:"",image_urls:JSON.stringify([]),title:r.title,text:r.text,start_time:r.start_time,end_time:r.end_time};console.log("调用AddActivity接口，参数:",i);const s=await xe(i);if(console.log("AddActivity接口响应:",s),s.code===0||s.code===200){const m=s.activity_id;console.log("获取到的activity_id:",m);try{if(h.value&&(console.log("开始上传主图片:",h.value.name),await ue(h.value,e,m),console.log("主图片上传成功")),x.value.length>0){console.log("开始上传详情图片，共",x.value.length,"个文件");for(const _ of x.value)console.log(`上传详情图片: ${_.name}`),await me(_,e,m),console.log(`详情图片 ${_.name} 上传成功`)}}catch(_){console.error("图片上传失败:",_),d.warning("活动创建成功，但部分图片上传失败")}d.success("添加活动成功"),V.value=!1,R()}else d.error(s.msg||"添加活动失败")}catch(t){console.error("添加活动失败:",t),d.error("添加活动失败")}finally{F.value=!1}};return _e(()=>{R()}),(t,e)=>{const i=u("ele-Plus"),s=u("el-icon"),m=u("el-button"),_=u("ele-Refresh"),v=u("ele-Picture"),z=u("el-image"),se=u("el-empty"),S=u("el-dialog"),q=u("el-input"),P=u("el-form-item"),G=u("el-upload"),L=u("el-date-picker"),ne=u("el-form"),re=fe("loading");return f(),y("div",Pe,[o("div",Ve,[o("div",Ie,[l(m,{type:"primary",size:"default",onClick:$},{default:a(()=>[l(s,null,{default:a(()=>[l(i)]),_:1}),e[7]||(e[7]=w(" 添加活动 ",-1))]),_:1}),l(m,{type:"success",size:"default",onClick:X,class:"ml10"},{default:a(()=>[l(s,null,{default:a(()=>[l(_)]),_:1}),e[8]||(e[8]=w(" 刷新 ",-1))]),_:1})]),ge((f(),y("div",be,[(f(!0),y(j,null,E(k.value,(n,M)=>(f(),y("div",{key:M,class:"activity-card",onClick:Le=>W(n)},[o("div",Ae,[l(z,{src:n.main_pic,fit:"cover",lazy:"","preview-disabled":!0},{error:a(()=>[o("div",Me,[l(s,null,{default:a(()=>[l(v)]),_:1})])]),_:2},1032,["src"])]),o("div",Ce,[o("h3",Ye,I(n.title),1),e[9]||(e[9]=o("p",{class:"activity-desc"},"点击查看详情",-1))])],8,ke))),128)),!b.value&&k.value.length===0?(f(),y("div",Fe,[l(se,{description:"暂无活动数据"},{default:a(()=>[l(m,{type:"primary",onClick:$},{default:a(()=>[...e[10]||(e[10]=[w("添加第一个活动",-1)])]),_:1})]),_:1})])):C("",!0)])),[[re,b.value]])]),l(S,{modelValue:Y.value,"onUpdate:modelValue":e[0]||(e[0]=n=>Y.value=n),title:"活动详情",width:"800px","destroy-on-close":""},{default:a(()=>[p.value?(f(),y("div",Re,[o("div",Ue,[o("h2",null,I(p.value.title),1),o("div",Be,[o("p",null,[e[11]||(e[11]=o("strong",null,"开始时间：",-1)),w(I(N(p.value.start_time)),1)]),o("p",null,[e[12]||(e[12]=o("strong",null,"结束时间：",-1)),w(I(N(p.value.end_time)),1)])])]),p.value.image_urls&&p.value.image_urls.length>0?(f(),y("div",He,[e[13]||(e[13]=o("h3",null,"活动图片",-1)),o("div",Ne,[(f(!0),y(j,null,E(p.value.image_urls,(n,M)=>(f(),O(z,{key:M,src:n,"preview-src-list":p.value.image_urls,"initial-index":M,fit:"cover",class:"detail-image"},{error:a(()=>[o("div",$e,[l(s,null,{default:a(()=>[l(v)]),_:1})])]),_:2},1032,["src","preview-src-list","initial-index"]))),128))])])):C("",!0),o("div",ze,[e[14]||(e[14]=o("h3",null,"活动详情",-1)),o("div",Se,I(p.value.text),1)])])):C("",!0)]),_:1},8,["modelValue"]),l(S,{modelValue:V.value,"onUpdate:modelValue":e[6]||(e[6]=n=>V.value=n),title:"添加活动",width:"700px","destroy-on-close":""},{footer:a(()=>[o("span",qe,[l(m,{onClick:e[5]||(e[5]=n=>V.value=!1)},{default:a(()=>[...e[17]||(e[17]=[w("取消",-1)])]),_:1}),l(m,{type:"primary",loading:F.value,onClick:oe},{default:a(()=>[...e[18]||(e[18]=[w(" 确定 ",-1)])]),_:1},8,["loading"])])]),default:a(()=>[l(ne,{model:r,rules:J,ref_key:"addFormRef",ref:A,"label-width":"100px"},{default:a(()=>[l(P,{label:"活动标题",prop:"title"},{default:a(()=>[l(q,{modelValue:r.title,"onUpdate:modelValue":e[1]||(e[1]=n=>r.title=n),placeholder:"请输入活动标题"},null,8,["modelValue"])]),_:1}),l(P,{label:"主图片",prop:"main_pic"},{default:a(()=>[l(G,{ref_key:"mainPicUploadRef",ref:Q,"file-list":g.value,"auto-upload":!1,limit:1,"list-type":"picture-card","on-change":te,"on-remove":le,"before-upload":ee,accept:"image/*",class:ye(["main-pic-upload",{"hide-upload":g.value.length>0}])},{tip:a(()=>[...e[15]||(e[15]=[o("div",{class:"el-upload__tip"},"只能上传一张主图片，jpg/png文件，且不超过10MB",-1)])]),default:a(()=>[g.value.length===0?(f(),O(s,{key:0},{default:a(()=>[l(i)]),_:1})):C("",!0)]),_:1},8,["file-list","class"])]),_:1}),l(P,{label:"详情图片"},{default:a(()=>[l(G,{ref_key:"detailPicsUploadRef",ref:K,"file-list":H.value,"auto-upload":!1,limit:9,"list-type":"picture-card","on-change":ie,"on-remove":ae,accept:"image/*",multiple:""},{tip:a(()=>[...e[16]||(e[16]=[o("div",{class:"el-upload__tip"},"可上传多张详情图片，最多9张，jpg/png文件，且不超过10MB",-1)])]),default:a(()=>[l(s,null,{default:a(()=>[l(i)]),_:1})]),_:1},8,["file-list"])]),_:1}),l(P,{label:"开始时间",prop:"start_time"},{default:a(()=>[l(L,{modelValue:r.start_time,"onUpdate:modelValue":e[2]||(e[2]=n=>r.start_time=n),type:"datetime",placeholder:"选择开始时间",style:{width:"100%"},format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),l(P,{label:"结束时间",prop:"end_time"},{default:a(()=>[l(L,{modelValue:r.end_time,"onUpdate:modelValue":e[3]||(e[3]=n=>r.end_time=n),type:"datetime",placeholder:"选择结束时间",style:{width:"100%"},format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),l(P,{label:"活动详情",prop:"text"},{default:a(()=>[l(q,{modelValue:r.text,"onUpdate:modelValue":e[4]||(e[4]=n=>r.text=n),type:"textarea",rows:6,placeholder:"请输入活动详情"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Je=he(Ge,[["__scopeId","data-v-b051a1de"]]);export{Je as default};
