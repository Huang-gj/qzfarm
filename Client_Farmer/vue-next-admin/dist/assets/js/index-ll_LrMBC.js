import{l as $,r as U,M as ie,p as R,w as de,A as _,O as J,C as I,H as n,D as i,B as D,G as A,P as x,$ as ce,a0 as me,aa as ue,J as b,ab as fe,S as w,ac as C,T,e as c}from"./.store-CUxRj2E2.js";import{c as ge,u as P,d as _e}from"./farm-38Bfv4JU.js";import{b as ve,S}from"./index-ehGYOv3s.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ie={class:"layout-pd"},ye={class:"image-urls-container"},he={class:"button-container"},De={key:1,class:"bound-actions"},Fe=$({name:"tools"}),Ue=$({...Fe,setup(be){const V=ve(),k=U(!1),p=U(!1),v=U(!1),u=U(!1),d=U(""),m=U("warning"),e=ie({farm_id:0,farm_name:"",description:"",address:"",logo_url:"",image_urls:"",contact_phone:""}),y=U(0),t=U([""]),F=R(()=>k.value&&!p.value),E=R(()=>e.farm_name&&e.address&&e.contact_phone&&e.description),z=()=>{t.value.length<5&&t.value.push("")},j=r=>{t.value.length>1&&t.value.splice(r,1)},G=()=>{if(console.log("=== getFarmId工具函数执行 ==="),e.farm_id&&e.farm_id!==0)return console.log("从farmForm获取farm_id:",e.farm_id),e.farm_id;const r=S.get("farmInfo");if(r){const l=r.farm_id||r.FarmID||r.farmId||r.id||r.ID;if(l&&l!==0)return console.log("从缓存获取farm_id:",l),e.farm_id=l,l}const a=V.getUserInfo;if(a){const l=a.farm_id||a.FarmID||a.farmId;if(l&&l!==0)return console.log("从userInfo获取farm_id:",l),e.farm_id=l,l}return console.error("无法获取有效的farm_id"),0},L=async()=>{try{u.value=!0,d.value="正在获取农场信息...",m.value="info";const r=V.getUserInfo;if(!r||!r.admin_id)throw new Error("用户信息不完整");const a={admin_id:r.admin_id},l=await _e(a);if(console.log("获取农场信息响应:",l.code,l.msg||l.Msg),l.code===200){const o=l.farm||l.Farm;console.log("=== FarmID调试 - 后端响应数据检查 ==="),console.log("19. 后端原始农场数据:",o),console.log("20. farmData.farm_id:",o.farm_id),console.log("21. farmData.FarmID:",o.FarmID),console.log("22. farmData.farmId:",o.farmId),console.log("23. farmData.id:",o.id),console.log("24. farmData.ID:",o.ID);let s=o.farm_id||o.FarmID||o.farmId||o.id||o.ID;if(console.log("25. 从后端提取到的farm_id:",s),console.log("26. farm_id类型:",typeof s),!s||s===0){console.error("27. 警告：从后端获取的farm_id无效！"),c.error("获取到的农场ID无效，请联系管理员");return}if(e.farm_id=s,e.farm_name=o.farm_name||o.FarmName||"",e.description=o.description||o.Description||"",e.address=o.address||o.Address||"",e.logo_url=o.logo_url||o.LogoURL||"",e.contact_phone=o.contact_phone||o.ContactPhone||"",y.value=o.status||o.Status||0,console.log("28. 从后端设置后的farm_id:",e.farm_id),console.log("29. 从后端设置后的farmStatus:",y.value),o.image_urls||o.ImageURLs){const f=o.image_urls||o.ImageURLs;try{const M=JSON.parse(f);t.value=Array.isArray(M)?M:[f]}catch{t.value=f.includes(",")?f.split(",").filter(M=>M.trim()):[f]}}else t.value=[""];t.value.length===0&&(t.value=[""]),k.value=!0,v.value=y.value===1,d.value=v.value?"农场当前为暂停运营状态":"农场信息加载成功！",m.value=v.value?"warning":"success";const g={farm_id:e.farm_id,FarmID:e.farm_id,farm_name:e.farm_name,description:e.description,address:e.address,logo_url:e.logo_url,image_urls:e.image_urls,contact_phone:e.contact_phone,status:y.value};console.log("30. 保存到缓存的数据:",g),S.set("farmInfo",g),console.log("=== FarmID调试 - 后端处理结束 ==="),c.success("农场信息获取成功")}else if(l.code===10001)k.value=!1,v.value=!1,d.value="您尚未绑定农场，请填写农场信息进行绑定。",m.value="warning";else throw new Error(l.msg||l.Msg||"获取农场信息失败")}catch(r){console.error("获取农场信息失败:",r.message||r),k.value=!1,d.value="获取农场信息失败，请检查网络连接或联系管理员。",m.value="error",c.error(r.message||"获取农场信息失败")}finally{u.value=!1}},H=async()=>{if(!E.value){c.warning("请填写完整的农场信息");return}try{u.value=!0;const r=V.getUserInfo;if(!r||!r.admin_id){c.error("用户信息不完整，无法绑定农场");return}const a=t.value.filter(f=>f.trim()!==""),l=JSON.stringify(a),o={admin_id:r.admin_id,bind_farm:{farm_name:e.farm_name,description:e.description,address:e.address,logo_url:e.logo_url,image_urls:l,contact_phone:e.contact_phone,status:0}},s=await ge(o);if(console.log("绑定农场响应:",s.code,s.msg||s.Msg),s.code===200||s.Code===200||s.msg&&s.msg.includes("成功")||s.Msg&&s.Msg.includes("成功"))c.success("农场绑定成功！"),d.value="农场绑定成功！正在刷新数据...",m.value="success",setTimeout(()=>{L()},1e3);else{const f=s.msg||s.Msg||"绑定农场失败";throw new Error(f)}}catch(r){console.error("绑定农场失败:",r),c.error(r.message||"绑定农场失败"),d.value="绑定农场失败，请重试",m.value="error"}finally{u.value=!1}},q=async()=>{p.value?await K():(p.value=!0,d.value="现在可以修改农场信息，修改完成后请点击保存",m.value="warning")},K=async()=>{if(!E.value){c.warning("请填写完整的农场信息");return}console.log("保存修改 - 当前farmForm:",e),console.log("保存修改 - farm_id:",e.farm_id),console.log("保存修改 - imageUrlsArray:",t.value);const r=G();if(!r||r===0){c.error("农场ID无效，请刷新页面重试或联系管理员");return}console.log("=== 操作前最终确认 ==="),console.log("最终使用的farm_id:",r),console.log("操作类型: 保存农场修改");try{u.value=!0;const a=V.getUserInfo;if(!a||!a.admin_id){c.error("用户信息不完整，无法修改农场");return}const l=t.value.filter(f=>f.trim()!==""),o=l.length>0?JSON.stringify(l):"",s={del:0,status:-1,farm:{farm_id:r,farm_name:e.farm_name,description:e.description,address:e.address,logo_url:e.logo_url,image_urls:"",contact_phone:e.contact_phone}};console.log("修改农场请求参数:",JSON.stringify(s,null,2));const g=await P(s);if(console.log("修改农场响应:",g.code,g.msg),g.code===200){c.success("农场信息修改成功！"),d.value="农场信息修改成功！",m.value="success",p.value=!1;const f={...e,image_urls:o};S.set("farmInfo",f)}else{const f=g.msg||"修改农场失败";throw new Error(f)}}catch(a){console.error("修改农场失败:",a),c.error(a.message||"修改农场失败"),d.value="修改农场失败，请重试",m.value="error"}finally{u.value=!1}},Q=()=>{p.value=!1,O(),d.value="已取消修改，农场信息已恢复",m.value="warning",c.info("已取消修改")},O=()=>{try{const r=S.get("farmInfo");if(console.log("=== FarmID调试 - 缓存数据检查 ==="),console.log("1. 原始缓存数据:",r),console.log("2. 缓存数据类型:",typeof r),console.log("3. 缓存是否为null/undefined:",r==null),r){const a=r;console.log("4. farmData.farm_id:",a.farm_id),console.log("5. farmData.FarmID:",a.FarmID),console.log("6. farmData.farmId:",a.farmId),console.log("7. farmData.id:",a.id),console.log("8. farmData.ID:",a.ID);let l=a.farm_id||a.FarmID||a.farmId||a.id||a.ID;if(console.log("9. 提取到的farm_id:",l),console.log("10. farm_id类型:",typeof l),!l||l===0){console.log("11. 从缓存未找到有效farm_id，尝试从userInfo获取");const o=V.getUserInfo;console.log("12. userInfo:",o),console.log("13. userInfo.farm_id:",o==null?void 0:o.farm_id),console.log("14. userInfo.FarmID:",o==null?void 0:o.FarmID),l=(o==null?void 0:o.farm_id)||(o==null?void 0:o.FarmID)||0,console.log("15. 从userInfo提取的farm_id:",l)}if(!l||l===0){console.log("16. 仍未找到有效farm_id，重新从后端获取"),L();return}if(e.farm_id=l,e.farm_name=a.farm_name||a.FarmName||"",e.description=a.description||a.Description||"",e.address=a.address||a.Address||"",e.logo_url=a.logo_url||a.LogoURL||"",e.contact_phone=a.contact_phone||a.ContactPhone||"",y.value=a.status||a.Status||0,console.log("17. 最终设置的farm_id:",e.farm_id),console.log("18. 最终设置的farmStatus:",y.value),console.log("=== FarmID调试结束 ==="),a.image_urls||a.ImageURLs){const o=a.image_urls||a.ImageURLs;try{const s=JSON.parse(o);t.value=Array.isArray(s)?s:[o]}catch{t.value=o.includes(",")?o.split(",").filter(s=>s.trim()):[o]}}else t.value=[""];t.value.length===0&&(t.value=[""]),k.value=!0,v.value=y.value===1,d.value=v.value?"农场当前为暂停运营状态":"农场信息加载成功！",m.value=v.value?"warning":"success"}else console.log("缓存中没有农场信息，尝试从后端获取"),L()}catch(r){console.error("从缓存加载农场信息失败:",r),L()}},W=async()=>{if(!u.value){if((!e.farm_id||e.farm_id===0)&&(console.error("=== FarmID错误调试 ==="),console.error("farm_id无效:",e.farm_id),console.error("当前farmForm完整数据:",e),console.error("当前缓存数据:",S.get("farmInfo")),console.error("当前userInfo:",V.getUserInfo),console.error("=== 尝试重新加载农场信息 ==="),O(),!e.farm_id||e.farm_id===0)){c.error("农场ID无效，请刷新页面重试或联系管理员");return}console.log("=== 操作前最终确认 ==="),console.log("最终使用的farm_id:",e.farm_id),console.log("操作类型: 解绑农场");try{u.value=!0,d.value="正在解绑农场...",m.value="warning";const r=t.value.filter(s=>s.trim()!==""),a=r.length>0?JSON.stringify(r):"",l={del:1,status:-1,farm:{farm_id:e.farm_id,farm_name:e.farm_name,description:e.description,address:e.address,logo_url:e.logo_url,image_urls:"",contact_phone:e.contact_phone}};console.log("解绑农场请求参数:",JSON.stringify(l,null,2));const o=await P(l);if(console.log("解绑农场响应:",o.code,o.msg),o.code===200)c.success("农场解绑成功！"),d.value="农场解绑成功！页面将重新加载...",m.value="success",k.value=!1,p.value=!1,y.value=0,Object.assign(e,{farm_id:0,farm_name:"",description:"",address:"",logo_url:"",image_urls:"",contact_phone:""}),t.value=[""],S.remove("farmInfo"),setTimeout(()=>{location.reload()},2e3);else{const s=o.msg||"解绑农场失败";throw new Error(s)}}catch(r){console.error("解绑农场失败:",r),c.error(r.message||"解绑农场失败"),d.value="解绑农场失败，请重试",m.value="error"}finally{u.value=!1}}},X=async()=>{if(!u.value){if((!e.farm_id||e.farm_id===0)&&(console.error("=== FarmID错误调试 ==="),console.error("farm_id无效:",e.farm_id),console.error("当前farmForm完整数据:",e),console.error("当前缓存数据:",S.get("farmInfo")),console.error("当前userInfo:",V.getUserInfo),console.error("=== 尝试重新加载农场信息 ==="),O(),!e.farm_id||e.farm_id===0)){c.error("农场ID无效，请刷新页面重试或联系管理员");return}console.log("=== 操作前最终确认 ==="),console.log("最终使用的farm_id:",e.farm_id),console.log("操作类型: 切换运营状态");try{u.value=!0,d.value="正在切换运营状态...",m.value="warning";const r=v.value?0:1;console.log("调试 - imageUrlsArray.value:",t.value),console.log("调试 - imageUrlsArray.value类型:",typeof t.value),console.log("调试 - imageUrlsArray.value是否为数组:",Array.isArray(t.value));const a=t.value.filter(g=>g.trim()!=="");console.log("调试 - filteredImageUrls:",a);const l=a.length>0?JSON.stringify(a):"";console.log("调试 - 最终的imageUrlsString:",l),console.log("调试 - imageUrlsString类型:",typeof l);const o={del:0,status:r,farm:{farm_id:e.farm_id,farm_name:e.farm_name,description:e.description,address:e.address,logo_url:e.logo_url,image_urls:"",contact_phone:e.contact_phone}};console.log("切换运营状态请求参数:",JSON.stringify(o,null,2));const s=await P(o);if(console.log("切换运营状态响应:",s.code,s.msg),s.code===200){c.success("农场运营状态切换成功！"),v.value=!v.value,y.value=v.value?1:0,d.value=`农场已${v.value?"暂停":"恢复"}运营`,m.value=v.value?"warning":"success",p.value=!1;const g={...e,status:y.value};S.set("farmInfo",g)}else{const g=s.msg||"切换运营状态失败";throw new Error(g)}}catch(r){console.error("切换运营状态失败:",r),c.error(r.message||"切换运营状态失败"),d.value="切换运营状态失败，请重试",m.value="error"}finally{u.value=!1}}};return de(()=>{O()}),(r,a)=>{const l=_("el-input"),o=_("el-form-item"),s=_("el-button"),g=_("ele-Plus"),f=_("ele-Connection"),M=_("ele-SuccessFilled"),Y=_("el-tag"),Z=_("ele-Edit"),ee=_("ele-Check"),ae=_("ele-Close"),oe=_("ele-Delete"),le=_("ele-VideoPause"),re=_("ele-VideoPlay"),se=_("el-form"),ne=_("el-alert"),te=_("el-card");return I(),J("div",Ie,[n(te,{shadow:"hover",header:"农场绑定"},{default:i(()=>[n(se,{model:e,"label-width":"120px",size:"default",class:"farm-form"},{default:i(()=>[n(o,{label:"农场名称："},{default:i(()=>[n(l,{modelValue:e.farm_name,"onUpdate:modelValue":a[0]||(a[0]=h=>e.farm_name=h),placeholder:"请输入农场名称",disabled:F.value,clearable:""},null,8,["modelValue","disabled"])]),_:1}),n(o,{label:"农场描述："},{default:i(()=>[n(l,{modelValue:e.description,"onUpdate:modelValue":a[1]||(a[1]=h=>e.description=h),type:"textarea",rows:3,placeholder:"请输入农场描述",disabled:F.value,clearable:""},null,8,["modelValue","disabled"])]),_:1}),n(o,{label:"农场地址："},{default:i(()=>[n(l,{modelValue:e.address,"onUpdate:modelValue":a[2]||(a[2]=h=>e.address=h),placeholder:"请输入农场地址",disabled:F.value,clearable:""},null,8,["modelValue","disabled"])]),_:1}),n(o,{label:"联系电话："},{default:i(()=>[n(l,{modelValue:e.contact_phone,"onUpdate:modelValue":a[3]||(a[3]=h=>e.contact_phone=h),placeholder:"请输入联系电话",disabled:F.value,clearable:""},null,8,["modelValue","disabled"])]),_:1}),n(o,{label:"Logo URL："},{default:i(()=>[n(l,{modelValue:e.logo_url,"onUpdate:modelValue":a[4]||(a[4]=h=>e.logo_url=h),placeholder:"请输入Logo图片地址",disabled:F.value,clearable:""},null,8,["modelValue","disabled"])]),_:1}),n(o,{label:"农场图片："},{default:i(()=>[x("div",ye,[(I(!0),J(ce,null,me(t.value,(h,N)=>(I(),J("div",{key:N,class:"image-url-item"},[n(l,{modelValue:t.value[N],"onUpdate:modelValue":B=>t.value[N]=B,placeholder:`农场图片${N+1}地址`,disabled:F.value,clearable:""},ue({_:2},[F.value?void 0:{name:"append",fn:i(()=>[n(s,{onClick:B=>j(N),type:"danger",icon:b(fe)},{default:i(()=>[...a[5]||(a[5]=[w("删除",-1)])]),_:2},1032,["onClick","icon"])]),key:"0"}]),1032,["modelValue","onUpdate:modelValue","placeholder","disabled"])]))),128)),!F.value&&t.value.length<5?(I(),D(s,{key:0,onClick:z,type:"primary",plain:"",class:"mt10"},{default:i(()=>[n(b(C),null,{default:i(()=>[n(g)]),_:1}),a[6]||(a[6]=w(" 添加图片地址 ",-1))]),_:1})):A("",!0)])]),_:1}),n(o,null,{default:i(()=>[x("div",he,[k.value?(I(),J("div",De,[n(Y,{type:"success",size:"large",class:"mr10"},{default:i(()=>[n(b(C),null,{default:i(()=>[n(M)]),_:1}),a[8]||(a[8]=w(" 农场已绑定 ",-1))]),_:1}),n(s,{type:p.value?"primary":"warning",onClick:q,loading:u.value,disabled:p.value&&!E.value},{default:i(()=>[n(b(C),null,{default:i(()=>[p.value?(I(),D(ee,{key:1})):(I(),D(Z,{key:0}))]),_:1}),w(" "+T(p.value?"保存修改":"修改农场信息"),1)]),_:1},8,["type","loading","disabled"]),p.value?(I(),D(s,{key:0,type:"info",onClick:Q,disabled:u.value,class:"ml10"},{default:i(()=>[n(b(C),null,{default:i(()=>[n(ae)]),_:1}),a[9]||(a[9]=w(" 取消修改 ",-1))]),_:1},8,["disabled"])):A("",!0),p.value?A("",!0):(I(),D(s,{key:1,type:"danger",onClick:W,loading:u.value},{default:i(()=>[n(b(C),null,{default:i(()=>[n(oe)]),_:1}),a[10]||(a[10]=w(" 解绑农场 ",-1))]),_:1},8,["loading"])),p.value?A("",!0):(I(),D(s,{key:2,type:"warning",onClick:X,loading:u.value},{default:i(()=>[n(b(C),null,{default:i(()=>[v.value?(I(),D(re,{key:1})):(I(),D(le,{key:0}))]),_:1}),w(" "+T(v.value?"开始运营":"暂停运营"),1)]),_:1},8,["loading"]))])):(I(),D(s,{key:0,type:"primary",onClick:H,loading:u.value,disabled:!E.value},{default:i(()=>[n(b(C),null,{default:i(()=>[n(f)]),_:1}),a[7]||(a[7]=w(" 确认绑定 ",-1))]),_:1},8,["loading","disabled"]))])]),_:1})]),_:1},8,["model"]),d.value?(I(),D(ne,{key:0,title:d.value,type:m.value,closable:!1,class:"mt20"},null,8,["title","type"])):A("",!0)]),_:1})])}}}),Ce=pe(Ue,[["__scopeId","data-v-d4582209"]]);export{Ce as default};
