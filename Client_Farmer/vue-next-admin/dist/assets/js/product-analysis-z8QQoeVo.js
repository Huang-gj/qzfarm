import{l as E,r as q,M as J,y as K,w as Q,n as X,A as f,a5 as Z,O as z,C as T,P as r,H as d,D as v,S as $,$ as ee,a0 as te,B as A,T as y,F as ae,a2 as oe,e as _}from"./.store-B6_YEv0p.js";import{b as re,S as se}from"./index-LdrvTkjS.js";import{b as F}from"./farm-DMiypgV0.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const le={class:"product-analysis-container layout-pd"},ie={class:"time-selector mb15"},ce={class:"time-buttons"},de={class:"time-info"},ve={class:"card-content"},ge={class:"card-info"},pe={class:"card-value"},ue=["innerHTML"],we={class:"card-content"},me={class:"card-info"},fe={class:"card-value"},he=["innerHTML"],_e={class:"card-content"},ye={class:"card-info"},De={class:"card-value"},Se=["innerHTML"],be={class:"card-content"},Te={class:"card-info"},$e={class:"card-value"},xe=["innerHTML"],ke={class:"pagination-container"},Oe=E({name:"productAnalysis"}),Ce=E({...Oe,setup(Ge){const I=re(),x=q(),e=J({activeTimeType:"year",selectedTime:"",timeOptions:[],loading:!1,overview:{totalOrders:0,totalSales:0,avgOrderValue:0,activeDays:0,ordersGrowth:"",salesGrowth:"",avgGrowth:"",daysGrowth:""},tableData:[],allData:[],pagination:{page:1,size:20,total:0},chart:null}),D=(o,t)=>{if(t===0)return o>0?'环比增长率：<span style="color: #F56C6C;">+∞%</span>':'环比增长率：<span style="color: #909399;">0%</span>';const a=(o/t-1)*100,s=Math.abs(a).toFixed(1);return a>0?`环比增长率：<span style="color: #F56C6C;">+${s}%</span>`:a<0?`环比增长率：<span style="color: #67C23A;">-${s}%</span>`:'环比增长率：<span style="color: #909399;">0%</span>'},Y=(o=[])=>{const t=e.allData;if(console.log("更新概览数据 - 当前数据:",t),console.log("更新概览数据 - 上一周期数据:",o),e.overview.totalOrders=t.reduce((a,s)=>a+s.good_order_count,0),e.overview.totalSales=t.reduce((a,s)=>a+s.good_sale_count,0),e.overview.avgOrderValue=e.overview.totalOrders>0?e.overview.totalSales/e.overview.totalOrders:0,e.overview.activeDays=t.filter(a=>a.good_order_count>0).length,o.length>0){const a=o.reduce((n,l)=>n+l.good_order_count,0),s=o.reduce((n,l)=>n+l.good_sale_count,0),i=a>0?s/a:0,c=o.filter(n=>n.good_order_count>0).length;console.log("计算环比 - 当前指标:",{totalOrders:e.overview.totalOrders,totalSales:e.overview.totalSales,avgOrderValue:e.overview.avgOrderValue,activeDays:e.overview.activeDays}),console.log("计算环比 - 上一周期指标:",{totalOrders:a,totalSales:s,avgOrderValue:i,activeDays:c}),e.overview.ordersGrowth=D(e.overview.totalOrders,a),e.overview.salesGrowth=D(e.overview.totalSales,s),e.overview.avgGrowth=D(e.overview.avgOrderValue,i),e.overview.daysGrowth=D(e.overview.activeDays,c),console.log("计算出的环比:",{ordersGrowth:e.overview.ordersGrowth,salesGrowth:e.overview.salesGrowth,avgGrowth:e.overview.avgGrowth,daysGrowth:e.overview.daysGrowth})}else console.log("没有上一周期数据，设置为N/A"),e.overview.ordersGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.salesGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.avgGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.daysGrowth='环比增长率：<span style="color: #909399;">N/A</span>'},S=()=>{const o=(e.pagination.page-1)*e.pagination.size,t=o+e.pagination.size;e.tableData=e.allData.slice(o,t),e.pagination.total=e.allData.length},L=()=>{x.value&&(e.chart=oe(x.value),C())},C=()=>{if(!e.chart)return;const o=e.allData.map(i=>i.stat_date),t=e.allData.map(i=>i.good_order_count),a=e.allData.map(i=>i.good_sale_count),s={title:{text:"农产品销售趋势",left:"center",textStyle:{fontSize:16}},tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["订单数量","销售金额"],top:30},grid:{top:70,left:50,right:50,bottom:50},xAxis:{type:"category",data:o,axisLabel:{rotate:45,fontSize:10}},yAxis:[{type:"value",name:"订单数量",position:"left",axisLabel:{formatter:"{value}"}},{type:"value",name:"销售金额",position:"right",axisLabel:{formatter:"¥{value}"}}],series:[{name:"订单数量",type:"bar",yAxisIndex:0,data:t,itemStyle:{color:"#409EFF"}},{name:"销售金额",type:"line",yAxisIndex:1,data:a,smooth:!0,itemStyle:{color:"#67C23A"},lineStyle:{color:"#67C23A"}}]};e.chart.setOption(s)},k=async()=>{try{e.loading=!0;const o=P();if(!o){_.error("未找到农场信息，请先绑定农场");return}if(!e.selectedTime){_.error("请选择查看时间");return}console.log("选中的时间:",e.selectedTime),console.log("时间类型:",e.activeTimeType);const t=U(e.activeTimeType,e.selectedTime);if(console.log("计算的时间范围:",t),!t.startDate||!t.endDate){_.error("时间范围计算错误，请重新选择");return}const a={farm_id:o,start_date:t.startDate,end_date:t.endDate};console.log("请求参数:",a);const s=await F(a);if(s.code===200){e.allData=s.sale_data||[];const i=V(e.activeTimeType,e.selectedTime);let c=[];if(i){const n={farm_id:o,start_date:i.startDate,end_date:i.endDate};console.log("上一周期请求参数:",n);try{const l=await F(n);l.code===200&&(c=l.sale_data||[],console.log("上一周期数据:",c))}catch(l){console.warn("获取上一周期数据失败:",l)}}Y(c),S(),C()}else _.error(`获取数据失败: ${s.msg}`)}catch(o){console.error("获取销售数据失败:",o),_.error("获取数据失败，请稍后重试")}finally{e.loading=!1}},O=o=>{if(console.log("切换时间类型到:",o),e.activeTimeType=o,e.timeOptions=G(o),console.log("生成的时间选项:",e.timeOptions),e.timeOptions.length>0)e.selectedTime=e.timeOptions[0].value,console.log("默认选择的时间:",e.selectedTime);else{console.error("没有生成时间选项"),_.error("无法生成时间选项，请刷新页面重试");return}e.pagination.page=1,k()},R=()=>{e.pagination.page=1,k()},H=o=>{e.pagination.size=o,e.pagination.page=1,S()},B=o=>{e.pagination.page=o,S()};K(()=>e.allData,()=>{S()});const P=()=>{const o=I.getUserInfo,t=se.get("farmInfo");let a=0;return t!=null&&t.farm_id?a=t.farm_id:o!=null&&o.farm_id&&(a=o.farm_id),a},G=o=>{console.log("生成时间选项，类型:",o);const a=new Date().getFullYear(),s=[];switch(o){case"year":for(let g=2025;g<=a;g++)s.push({value:g.toString(),label:`${g}年`});break;case"month":for(let g=1;g<=12;g++){const p=g.toString().padStart(2,"0");s.push({value:`${a}-${p}`,label:`${a}年${g}月`})}break;case"week":const c=new Date(a,0,1);let n=new Date(c);for(;n.getDay()!==1;)n.setDate(n.getDate()-1);let l=1;const w=52;for(;l<=w;){const g=new Date(n),p=new Date(n);if(p.setDate(g.getDate()+6),p.getFullYear()>a)break;const m=`${g.getFullYear()}-${(g.getMonth()+1).toString().padStart(2,"0")}-${g.getDate().toString().padStart(2,"0")}`,u=`${p.getFullYear()}-${(p.getMonth()+1).toString().padStart(2,"0")}-${p.getDate().toString().padStart(2,"0")}`;s.push({value:`${m}|${u}`,label:`${g.getMonth()+1}月${g.getDate()}日-${p.getMonth()+1}月${p.getDate()}日（第${l}周）`}),n.setDate(n.getDate()+7),l++}console.log("生成的周选项数量:",s.length);break}return s},U=(o,t)=>{let a="",s="";console.log("getTimeRange 输入:",{type:o,selectedValue:t});try{switch(o){case"year":const i=parseInt(t);if(isNaN(i))throw new Error("年份格式无效");a=`${i}-01-01`,s=`${i}-12-31`;break;case"month":const[c,n]=t.split("-"),l=parseInt(c),w=parseInt(n);if(isNaN(l)||isNaN(w))throw new Error("月份格式无效");a=`${l}-${n}-01`;const g=new Date(l,w,0).getDate();s=`${l}-${n}-${g.toString().padStart(2,"0")}`;break;case"week":if(!t||!t.includes("|"))throw new Error("周格式无效");const[p,m]=t.split("|");if(!p||!m)throw new Error("周日期范围无效");a=p,s=m;break;default:throw new Error("未知的时间类型")}}catch(i){console.error("时间范围计算错误:",i);const c=new Date,n=c.getFullYear(),l=(c.getMonth()+1).toString().padStart(2,"0"),w=c.getDate().toString().padStart(2,"0");a=`${n}-${l}-${w}`,s=`${n}-${l}-${w}`}return console.log("getTimeRange 输出:",{startDate:a,endDate:s}),{startDate:a,endDate:s}},V=(o,t)=>{let a="",s="";try{switch(o){case"year":const i=parseInt(t);if(isNaN(i))throw new Error("年份格式无效");const c=i-1;a=`${c}-01-01`,s=`${c}-12-31`;break;case"month":const[n,l]=t.split("-"),w=parseInt(n),g=parseInt(l);if(isNaN(w)||isNaN(g))throw new Error("月份格式无效");let p=w,m=g-1;m===0&&(m=12,p=w-1);const u=m.toString().padStart(2,"0");a=`${p}-${u}-01`;const W=new Date(p,m,0).getDate();s=`${p}-${u}-${W.toString().padStart(2,"0")}`;break;case"week":if(!t||!t.includes("|"))throw new Error("周格式无效");const[N,j]=t.split("|");if(!N||!j)throw new Error("周日期范围无效");const M=new Date(N),h=new Date(M);h.setDate(M.getDate()-7);const b=new Date(h);b.setDate(h.getDate()+6),a=`${h.getFullYear()}-${(h.getMonth()+1).toString().padStart(2,"0")}-${h.getDate().toString().padStart(2,"0")}`,s=`${b.getFullYear()}-${(b.getMonth()+1).toString().padStart(2,"0")}-${b.getDate().toString().padStart(2,"0")}`;break;default:throw new Error("未知的时间类型")}}catch(i){return console.error("上一周期时间范围计算错误:",i),null}return{startDate:a,endDate:s}};return Q(()=>{e.timeOptions=G(e.activeTimeType),e.timeOptions.length>0&&(e.selectedTime=e.timeOptions[0].value),X(()=>{L(),k()})}),(o,t)=>{const a=f("el-button"),s=f("el-option"),i=f("el-select"),c=f("el-card"),n=f("el-col"),l=f("el-row"),w=f("el-table-column"),g=f("el-table"),p=f("el-pagination"),m=Z("loading");return T(),z("div",le,[t[20]||(t[20]=r("div",{class:"page-header mb15"},[r("h2",null,"农产品数据分析"),r("p",null,"查看农产品订单数据的详细统计和趋势分析")],-1)),r("div",ie,[d(c,{class:"time-selector-card"},{default:v(()=>[r("div",ce,[d(a,{type:e.activeTimeType==="year"?"primary":"default",onClick:t[0]||(t[0]=u=>O("year")),size:"large"},{default:v(()=>[...t[6]||(t[6]=[$(" 年总结 ",-1)])]),_:1},8,["type"]),d(a,{type:e.activeTimeType==="month"?"primary":"default",onClick:t[1]||(t[1]=u=>O("month")),size:"large"},{default:v(()=>[...t[7]||(t[7]=[$(" 月总结 ",-1)])]),_:1},8,["type"]),d(a,{type:e.activeTimeType==="week"?"primary":"default",onClick:t[2]||(t[2]=u=>O("week")),size:"large"},{default:v(()=>[...t[8]||(t[8]=[$(" 周总结 ",-1)])]),_:1},8,["type"])]),r("div",de,[t[9]||(t[9]=r("span",{class:"time-label"},"当前查看：",-1)),d(i,{modelValue:e.selectedTime,"onUpdate:modelValue":t[3]||(t[3]=u=>e.selectedTime=u),onChange:R,style:{width:"200px"},placeholder:"请选择时间"},{default:v(()=>[(T(!0),z(ee,null,te(e.timeOptions,u=>(T(),A(s,{key:u.value,label:u.label,value:u.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),_:1})]),d(l,{gutter:15,class:"overview-cards mb15"},{default:v(()=>[d(n,{xs:24,sm:12,md:12,xl:12},{default:v(()=>[d(c,{class:"overview-card"},{default:v(()=>[r("div",ve,[t[11]||(t[11]=r("div",{class:"card-icon",style:{background:"var(--next-color-primary-lighter)"}},[r("i",{class:"fa fa-shopping-cart",style:{color:"var(--el-color-primary)"}})],-1)),r("div",ge,[r("div",pe,y(e.overview.totalOrders),1),t[10]||(t[10]=r("div",{class:"card-label"},"总订单数",-1)),r("div",{class:"card-growth",innerHTML:e.overview.ordersGrowth},null,8,ue)])])]),_:1})]),_:1}),d(n,{xs:24,sm:12,md:12,xl:12},{default:v(()=>[d(c,{class:"overview-card"},{default:v(()=>[r("div",we,[t[13]||(t[13]=r("div",{class:"card-icon",style:{background:"var(--next-color-success-lighter)"}},[r("i",{class:"fa fa-dollar",style:{color:"var(--el-color-success)"}})],-1)),r("div",me,[r("div",fe,"¥"+y(e.overview.totalSales.toFixed(2)),1),t[12]||(t[12]=r("div",{class:"card-label"},"总销售额",-1)),r("div",{class:"card-growth",innerHTML:e.overview.salesGrowth},null,8,he)])])]),_:1})]),_:1})]),_:1}),d(l,{gutter:15,class:"overview-cards mb15"},{default:v(()=>[d(n,{xs:24,sm:12,md:12,xl:12},{default:v(()=>[d(c,{class:"overview-card"},{default:v(()=>[r("div",_e,[t[15]||(t[15]=r("div",{class:"card-icon",style:{background:"var(--next-color-warning-lighter)"}},[r("i",{class:"fa fa-dollar",style:{color:"var(--el-color-warning)","font-size":"1.5em"}})],-1)),r("div",ye,[r("div",De,"¥"+y(e.overview.avgOrderValue.toFixed(2)),1),t[14]||(t[14]=r("div",{class:"card-label"},"平均订单金额",-1)),r("div",{class:"card-growth",innerHTML:e.overview.avgGrowth},null,8,Se)])])]),_:1})]),_:1}),d(n,{xs:24,sm:12,md:12,xl:12},{default:v(()=>[d(c,{class:"overview-card"},{default:v(()=>[r("div",be,[t[17]||(t[17]=r("div",{class:"card-icon",style:{background:"var(--next-color-danger-lighter)"}},[r("i",{class:"fa fa-calendar",style:{color:"var(--el-color-danger)"}})],-1)),r("div",Te,[r("div",$e,y(e.overview.activeDays),1),t[16]||(t[16]=r("div",{class:"card-label"},"活跃天数",-1)),r("div",{class:"card-growth",innerHTML:e.overview.daysGrowth},null,8,xe)])])]),_:1})]),_:1})]),_:1}),d(l,{class:"mb15"},{default:v(()=>[d(n,{span:24},{default:v(()=>[d(c,{class:"chart-card"},{header:v(()=>[...t[18]||(t[18]=[r("div",{class:"card-header"},[r("span",null,"销售趋势图表")],-1)])]),default:v(()=>[r("div",{ref_key:"chartRef",ref:x,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1}),d(l,null,{default:v(()=>[d(n,{span:24},{default:v(()=>[d(c,{class:"table-card"},{header:v(()=>[...t[19]||(t[19]=[r("div",{class:"card-header"},[r("span",null,"详细数据列表")],-1)])]),default:v(()=>[ae((T(),A(g,{data:e.tableData,style:{width:"100%"},"max-height":"320"},{default:v(()=>[d(w,{prop:"stat_date",label:"日期",width:"100"}),d(w,{prop:"good_order_count",label:"订单数",width:"80",align:"center"}),d(w,{prop:"good_sale_count",label:"销售额",align:"center"},{default:v(u=>[$(" ¥"+y(u.row.good_sale_count.toFixed(2)),1)]),_:1})]),_:1},8,["data"])),[[m,e.loading]]),r("div",ke,[d(p,{"current-page":e.pagination.page,"onUpdate:currentPage":t[4]||(t[4]=u=>e.pagination.page=u),"page-size":e.pagination.size,"onUpdate:pageSize":t[5]||(t[5]=u=>e.pagination.size=u),"page-sizes":[10,20,50,100],total:e.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:H,onCurrentChange:B},null,8,["current-page","page-size","total"])])]),_:1})]),_:1})]),_:1})])}}}),Fe=ne(Ce,[["__scopeId","data-v-01158a13"]]);export{Fe as default};
