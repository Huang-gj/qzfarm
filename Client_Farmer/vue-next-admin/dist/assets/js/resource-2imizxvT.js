import{g as ge,u as pe,d as _e}from"./product-Cn_vyG93.js";import{g as fe}from"./category-CovBP2IX.js";import{t as ye}from"./test-BEwnQFNk.js";import{b as ve,S as G}from"./index-mLlbfZu9.js";import{I as be}from"./index-B2JtjZyr.js";import{l as $,r as b,M as z,p as he,w as we,A as i,a5 as Ie,O as N,C as w,H as t,D as r,P as C,F as Ve,S as _,B as U,T as S,$ as Ce,a0 as Se,e as m,E as ke}from"./.store-DdqHRk86.js";import{_ as De}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe={class:"system-order-container layout-pd"},xe={class:"system-order-search mb15"},ze={key:1},Ne={class:"price-amount"},Ue={class:"price-unit"},Te={class:"system-order-pagination mt15"},Fe=$({name:"productResource"}),Ee=$({...Fe,setup(Be){const T=ve(),D=b(!1),I=b(!1),P=b(!1),F=b([]),d=z({id:0,good_id:0,good_name:"",good_tag:"",price:0,units:"",repertory:0,detail:"",image_urls:""});b("");const v=b([]),V=b([]),f=z({goodId:"",goodName:""}),g=z({currentPage:1,pageSize:20,total:0}),x=b([]),R=he(()=>{let o=x.value;f.goodId&&(o=o.filter(s=>{var u;return(u=s.good_id)==null?void 0:u.toString().includes(f.goodId)})),f.goodName&&(o=o.filter(s=>(s.good_name||"").includes(f.goodName))),g.total=o.length;const e=(g.currentPage-1)*g.pageSize,a=e+g.pageSize;return o.slice(e,a)}),E=()=>{const o=G.get("farmInfo");if(o)return o.farm_id||o.FarmID||o.farmId||null;const e=T.getUserInfo;return(e==null?void 0:e.farm_id)||(e==null?void 0:e.FarmID)||(e==null?void 0:e.farmId)||null},O=async(o,e,a)=>{const s=[];for(const u of a)if(u.raw){const p=ye(u.raw,o,e,-1).then(c=>{console.log(`文件 ${u.name} 上传成功:`,c)}).catch(c=>{throw console.error(`文件 ${u.name} 上传失败:`,c),new Error(`文件 ${u.name} 上传失败`)});s.push(p)}await Promise.all(s)},B=async()=>{try{const o=await fe({categoryType:1});o.code===200?F.value=o.category||[]:m.warning(o.msg||"获取类目列表失败")}catch(o){console.error("获取类目列表失败:",o),m.error("获取类目列表失败")}},k=async()=>{var o,e,a;try{D.value=!0;let s=null;const u=G.get("farmInfo");if(u&&(s=u.farm_id||u.FarmID||u.farmId),!s){const n=T.getUserInfo;s=(n==null?void 0:n.farm_id)||(n==null?void 0:n.FarmID)||(n==null?void 0:n.farmId)||null}if(!s){m.error("未找到农场信息，请先绑定农场");return}const p={product_type:1,farm_id:Number(s)};console.log("农产品资源管理-请求参数:",p);const c=await ge(p);if(console.log("农产品资源管理-接口响应:",c),(c.code===200||c.Code===200)&&(c.good||c.Good)){const n=c.good||c.Good||[];console.log("农产品资源管理-原始列表首条键名:",n!=null&&n[0]?Object.keys(n[0]):[]),console.log("农产品资源管理-原始列表首条(CreateTime?):",(o=n==null?void 0:n[0])==null?void 0:o.CreateTime,"create_time:",(e=n==null?void 0:n[0])==null?void 0:e.create_time,"createTime:",(a=n==null?void 0:n[0])==null?void 0:a.createTime),x.value=n.map(y=>({...y,create_time:y.create_time||y.CreateTime||y.createTime||"",good_tag:y.good_tag||y.GoodTag||y.goodTag||""})),console.log("农产品资源管理-资源数据(归一化后):",x.value),m.success("农产品资源加载成功")}else m.error(c.msg||c.Msg||"获取农产品资源失败")}catch(s){console.error("获取农产品资源失败:",s),m.error("获取农产品资源失败")}finally{D.value=!1}},j=o=>{if(!o)return"";try{return new Date(o).toLocaleString("zh-CN")}catch{return o}},A=o=>new Promise((e,a)=>{const s=new FileReader;s.onload=()=>e(String(s.result)),s.onerror=a,s.readAsDataURL(o)}),H=async(o,e)=>{if(v.value=e,o.raw){const a=await A(o.raw);V.value.push(a)}},J=(o,e)=>{v.value=e;const a=new Set((e||[]).map(s=>s.url).filter(Boolean));V.value=V.value.filter(s=>a.has(s)||s.startsWith("data:"))},W=o=>{d.id=o.id??o.ID??0,d.good_id=o.good_id??o.GoodID??0,d.good_name=o.good_name??o.GoodName??"",d.good_tag=o.good_tag??o.GoodTag??"",d.price=o.price??0,d.units=o.units??"",d.repertory=o.repertory??0,d.detail=o.detail??"",d.image_urls=o.image_urls??"";try{const e=o.image_urls?JSON.parse(o.image_urls):[];v.value=e.map((a,s)=>({name:`img_${s}`,url:a})),V.value=e.slice()}catch{v.value=[],V.value=[]}B(),I.value=!0},q=async()=>{const o=E();if(!o){m.error("未找到农场信息，请先绑定农场");return}try{P.value=!0,console.log("第一步：更新农产品信息...");const e={farm_id:Number(o),product_type:1,good_id:d.good_id||0,land_id:0,good:{id:d.id,good_id:d.good_id,good_name:d.good_name,good_tag:d.good_tag,price:d.price,units:d.units,repertory:d.repertory,detail:d.detail,image_urls:[],del_state:0,del_time:"",create_time:"",farm_id:Number(o)},land:{id:0,del_state:0,del_time:"",create_time:"",land_id:0,farm_id:Number(o),land_name:"",land_tag:"",area:"",image_urls:[],price:0,detail:"",sale_status:0,sale_time:""}},a=await pe(e);if(a.code===200||a.Code===200){if(console.log("第一步成功，准备上传图片..."),v.value&&v.value.length>0){console.log("第二步：上传农产品图片，good_id:",d.good_id);try{await O(Number(o),d.good_id||0,v.value),m.success("农产品信息修改并上传图片成功！")}catch(s){console.error("图片上传失败:",s),m.warning("农产品信息修改成功，但部分图片上传失败")}}else m.success(a.msg||a.Msg||"修改成功");I.value=!1,k()}else m.error(a.msg||a.Msg||"修改失败")}catch(e){console.error("修改失败:",e),m.error("修改失败")}finally{P.value=!1}},K=()=>{g.currentPage=1},Q=()=>{f.goodId="",f.goodName="",g.currentPage=1,k()},X=o=>{g.pageSize=o,g.currentPage=1},Y=o=>{g.currentPage=o},Z=async o=>{const e=E();if(!e){m.error("未找到农场信息，请先绑定农场");return}try{await ke.confirm("确定删除该农产品吗？","提示",{type:"warning"})}catch{return}try{const a=await _e({farm_id:Number(e),product_type:1,good_id:o.good_id??o.GoodID??0,land_id:0});a.code===200||a.Code===200?(m.success(a.msg||a.Msg||"删除成功"),k()):m.error(a.msg||a.Msg||"删除失败")}catch(a){console.error("删除失败:",a),m.error("删除失败")}};return we(()=>{k(),B()}),(o,e)=>{const a=i("el-input"),s=i("ele-Search"),u=i("el-icon"),p=i("el-button"),c=i("ele-Refresh"),n=i("el-table-column"),y=i("el-link"),L=i("el-tag"),ee=i("el-divider"),oe=i("el-table"),h=i("el-form-item"),te=i("el-option"),le=i("el-select"),M=i("el-input-number"),ae=i("ele-Plus"),ne=i("el-image"),re=i("el-upload"),de=i("el-form"),se=i("el-dialog"),ie=i("el-pagination"),ue=i("el-card"),me=Ie("loading");return w(),N("div",Pe,[t(ue,{shadow:"hover"},{default:r(()=>[C("div",xe,[t(a,{modelValue:f.goodId,"onUpdate:modelValue":e[0]||(e[0]=l=>f.goodId=l),size:"default",placeholder:"请输入商品ID",style:{"max-width":"180px"},clearable:""},{prepend:r(()=>[...e[12]||(e[12]=[_("商品ID",-1)])]),_:1},8,["modelValue"]),t(a,{modelValue:f.goodName,"onUpdate:modelValue":e[1]||(e[1]=l=>f.goodName=l),size:"default",placeholder:"请输入商品名称",style:{"max-width":"220px"},class:"ml10",clearable:""},{prepend:r(()=>[...e[13]||(e[13]=[_("商品名称",-1)])]),_:1},8,["modelValue"]),t(p,{size:"default",type:"primary",class:"ml10",onClick:K},{default:r(()=>[t(u,null,{default:r(()=>[t(s)]),_:1}),e[14]||(e[14]=_(" 查询 ",-1))]),_:1}),t(p,{size:"default",type:"success",class:"ml10",onClick:Q},{default:r(()=>[t(u,null,{default:r(()=>[t(c)]),_:1}),e[15]||(e[15]=_(" 刷新 ",-1))]),_:1})]),Ve((w(),U(oe,{data:R.value,style:{width:"100%"},border:"",stripe:""},{default:r(()=>[t(n,{type:"index",label:"序号",width:"60",align:"center"}),t(n,{prop:"good_id",label:"商品ID",width:"120",align:"center"},{default:r(l=>[t(y,{type:"primary"},{default:r(()=>[_(S(l.row.good_id),1)]),_:2},1024)]),_:1}),t(n,{label:"商品图片",width:"100",align:"center"},{default:r(l=>[t(be,{images:l.row.image_urls,width:"50px",height:"50px","show-controls":!0,"show-indicators":!1,"show-thumbnails":!1,"show-preview":!0,"border-radius":"4px"},null,8,["images"])]),_:1}),t(n,{prop:"good_name",label:"商品名称","min-width":"150","show-overflow-tooltip":""}),t(n,{prop:"good_tag",label:"标签",width:"140",align:"center"},{default:r(l=>[l.row.good_tag?(w(),U(L,{key:0,type:"info"},{default:r(()=>[_(S(l.row.good_tag),1)]),_:2},1024)):(w(),N("span",ze,"-"))]),_:1}),t(n,{label:"价格/单位",width:"140",align:"center"},{default:r(l=>[C("div",null,[C("div",Ne,"¥"+S(l.row.price),1),C("div",Ue,S(l.row.units),1)])]),_:1}),t(n,{prop:"repertory",label:"库存",width:"100",align:"center"}),t(n,{prop:"create_time",label:"创建时间",width:"160",align:"center"},{default:r(l=>[_(S(j(l.row.create_time)),1)]),_:1}),t(n,{prop:"detail",label:"商品详情","min-width":"180","show-overflow-tooltip":""}),t(n,{label:"操作",width:"160",align:"center"},{default:r(l=>[t(p,{type:"primary",link:"",onClick:ce=>W(l.row)},{default:r(()=>[...e[16]||(e[16]=[_("修改",-1)])]),_:2},1032,["onClick"]),t(ee,{direction:"vertical"}),t(p,{type:"danger",link:"",onClick:ce=>Z(l.row)},{default:r(()=>[...e[17]||(e[17]=[_("删除",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[me,D.value]]),t(se,{modelValue:I.value,"onUpdate:modelValue":e[9]||(e[9]=l=>I.value=l),title:"修改农产品资源",width:"640px","destroy-on-close":""},{footer:r(()=>[t(p,{onClick:e[8]||(e[8]=l=>I.value=!1)},{default:r(()=>[...e[18]||(e[18]=[_("取消",-1)])]),_:1}),t(p,{type:"primary",loading:P.value,onClick:q},{default:r(()=>[...e[19]||(e[19]=[_("保存",-1)])]),_:1},8,["loading"])]),default:r(()=>[t(de,{model:d,"label-width":"100px"},{default:r(()=>[t(h,{label:"商品名称"},{default:r(()=>[t(a,{modelValue:d.good_name,"onUpdate:modelValue":e[2]||(e[2]=l=>d.good_name=l)},null,8,["modelValue"])]),_:1}),t(h,{label:"商品类目"},{default:r(()=>[t(le,{modelValue:d.good_tag,"onUpdate:modelValue":e[3]||(e[3]=l=>d.good_tag=l),placeholder:"请选择商品类目",clearable:"",filterable:"",style:{width:"100%"}},{default:r(()=>[(w(!0),N(Ce,null,Se(F.value,l=>(w(),U(te,{key:l.category_id,label:l.name,value:l.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(h,{label:"价格"},{default:r(()=>[t(M,{modelValue:d.price,"onUpdate:modelValue":e[4]||(e[4]=l=>d.price=l),min:0,precision:2,step:.1},null,8,["modelValue"])]),_:1}),t(h,{label:"单位"},{default:r(()=>[t(a,{modelValue:d.units,"onUpdate:modelValue":e[5]||(e[5]=l=>d.units=l)},null,8,["modelValue"])]),_:1}),t(h,{label:"库存"},{default:r(()=>[t(M,{modelValue:d.repertory,"onUpdate:modelValue":e[6]||(e[6]=l=>d.repertory=l),min:0,step:1},null,8,["modelValue"])]),_:1}),t(h,{label:"商品图片"},{default:r(()=>[t(re,{"list-type":"picture-card",limit:9,"auto-upload":!1,"file-list":v.value,"on-change":H,"on-remove":J},{file:r(({file:l})=>[t(ne,{src:l.url,fit:"cover",style:{width:"100%",height:"100%"}},null,8,["src"])]),default:r(()=>[t(u,null,{default:r(()=>[t(ae)]),_:1})]),_:1},8,["file-list"])]),_:1}),t(h,{label:"详情"},{default:r(()=>[t(a,{modelValue:d.detail,"onUpdate:modelValue":e[7]||(e[7]=l=>d.detail=l),type:"textarea",rows:4},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),C("div",Te,[t(ie,{"current-page":g.currentPage,"onUpdate:currentPage":e[10]||(e[10]=l=>g.currentPage=l),"page-size":g.pageSize,"onUpdate:pageSize":e[11]||(e[11]=l=>g.pageSize=l),"page-sizes":[10,20,50,100],total:g.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:X,onCurrentChange:Y},null,8,["current-page","page-size","total"])])]),_:1})])}}}),He=De(Ee,[["__scopeId","data-v-b62ec662"]]);export{He as default};
