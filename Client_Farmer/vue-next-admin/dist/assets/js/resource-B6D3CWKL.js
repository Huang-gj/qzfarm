import{g as fe,u as ye,d as be}from"./product-JAvn1Rwx.js";import{g as ve}from"./category-D-5L-kf2.js";import{t as we}from"./test-CriR-2H5.js";import{b as he,S as R}from"./index-LdrvTkjS.js";import{I as Ve}from"./index-CogGUKok.js";import{l as Y,r as w,M as S,p as Ie,w as Ce,A as u,a5 as De,O as z,C as h,P,F as Ne,H as l,D as d,S as g,B as U,T as C,$ as Te,a0 as ke,e as c,E as Se}from"./.store-B6_YEv0p.js";import{_ as ze}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Pe={class:"system-land-resource-container layout-padding"},Ue={class:"system-land-resource-padding layout-padding-auto layout-padding-view"},xe={class:"system-land-resource-search mb15"},Me={key:1},Fe={class:"system-land-resource-pagination mt15"},$e=Y({name:"landResource"}),Ee=Y({...$e,setup(Be){const x=he(),N=w(!1),V=w(!1),T=w(!1),M=w([]),o=S({id:0,land_id:0,land_name:"",land_tag:"",area:"",price:0,sale_status:0,sale_time:"",detail:"",image_urls:""}),b=w([]),I=w([]),f=S({landId:"",landName:""}),_=S({currentPage:1,pageSize:20,total:0}),k=w([]),L=Ie(()=>{let a=k.value;f.landId&&(a=a.filter(s=>{var i;return(i=s.land_id)==null?void 0:i.toString().includes(f.landId)})),f.landName&&(a=a.filter(s=>(s.land_name||"").includes(f.landName))),_.total=a.length;const e=(_.currentPage-1)*_.pageSize,t=e+_.pageSize;return a.slice(e,t)}),F=()=>{const a=R.get("farmInfo");if(a)return a.farm_id||a.FarmID||a.farmId||null;const e=x.getUserInfo;return(e==null?void 0:e.farm_id)||(e==null?void 0:e.FarmID)||(e==null?void 0:e.farmId)||null},H=async(a,e,t)=>{const s=[];for(const i of t)if(i.raw){const p=we(i.raw,a,-1,e).then(m=>{console.log(`文件 ${i.name} 上传成功:`,m)}).catch(m=>{throw console.error(`文件 ${i.name} 上传失败:`,m),new Error(`文件 ${i.name} 上传失败`)});s.push(p)}await Promise.all(s)},$=async()=>{try{const a=await ve({categoryType:2});a.code===200?M.value=a.category||[]:c.warning(a.msg||"获取类目列表失败")}catch(a){console.error("获取类目列表失败:",a),c.error("获取类目列表失败")}},D=async()=>{var a,e,t;try{N.value=!0;let s=null;const i=R.get("farmInfo");if(i&&(s=i.farm_id||i.FarmID||i.farmId),!s){const r=x.getUserInfo;s=(r==null?void 0:r.farm_id)||(r==null?void 0:r.FarmID)||(r==null?void 0:r.farmId)||null}if(!s){c.error("未找到农场信息，请先绑定农场");return}const p={product_type:2,farm_id:Number(s)};console.log("土地资源管理-请求参数:",p);const m=await fe(p);if(console.log("土地资源管理-接口响应:",m),(m.code===200||m.Code===200)&&(m.land||m.Land)){const r=m.land||m.Land||[];console.log("土地资源管理-原始列表首条键名:",r!=null&&r[0]?Object.keys(r[0]):[]),console.log("土地资源管理-原始列表首条(CreateTime?):",(a=r==null?void 0:r[0])==null?void 0:a.CreateTime,"create_time:",(e=r==null?void 0:r[0])==null?void 0:e.create_time,"createTime:",(t=r==null?void 0:r[0])==null?void 0:t.createTime),k.value=r.map(y=>({...y,create_time:y.create_time||y.CreateTime||y.createTime||"",land_tag:y.land_tag||y.LandTag||y.landTag||""})),console.log("土地资源管理-资源数据(归一化后):",k.value),c.success("土地资源加载成功")}else c.error(m.msg||m.Msg||"获取土地资源失败")}catch(s){console.error("获取土地资源失败:",s),c.error("获取土地资源失败")}finally{N.value=!1}},O=a=>{if(!a)return"";const e=E(a);return e?e.toLocaleString("zh-CN"):a},E=a=>{if(a==null)return null;if(typeof a=="number"){const e=a>1e12?a:a*1e3,t=new Date(e);return isNaN(t.getTime())?null:t}if(typeof a=="string"){const e=a.trim();if(!e)return null;const t=Number(e);if(!isNaN(t)){const p=t>1e12?t:t*1e3,m=new Date(p);return isNaN(m.getTime())?null:m}const s=e.replace(/-/g,"/").replace("T"," ").replace(/Z$/i,""),i=new Date(s);return isNaN(i.getTime())?null:i}return null},j=a=>{const e=E(a);if(!e)return"租赁时间剩余：0天0小时0分钟";let t=e.getTime()-Date.now();if(t<=0)return"租赁时间剩余：0天0小时0分钟";const s=Math.floor(t/6e4),i=Math.floor(s/(60*24)),p=Math.floor(s%(60*24)/60),m=s%60;return`租赁时间剩余：${i}天${p}小时${m}分钟`},A=a=>new Promise((e,t)=>{const s=new FileReader;s.onload=()=>e(String(s.result)),s.onerror=t,s.readAsDataURL(a)}),J=async(a,e)=>{if(b.value=e,a.raw){const t=await A(a.raw);I.value.push(t)}},W=(a,e)=>{b.value=e;const t=new Set((e||[]).map(s=>s.url).filter(Boolean));I.value=I.value.filter(s=>t.has(s)||s.startsWith("data:"))},Z=a=>{o.id=a.id??a.ID??0,o.land_id=a.land_id??a.LandID??0,o.land_name=a.land_name??a.LandName??"",o.land_tag=a.land_tag??a.LandTag??"",o.area=a.area??"",o.price=a.price??0,o.sale_status=a.sale_status??0,o.sale_time=a.sale_time??"",o.detail=a.detail??"",o.image_urls=a.image_urls??"";try{const e=a.image_urls?JSON.parse(a.image_urls):[];b.value=e.map((t,s)=>({name:`img_${s}`,url:t})),I.value=e.slice()}catch{b.value=[],I.value=[]}$(),V.value=!0},q=async()=>{const a=F();if(!a){c.error("未找到农场信息，请先绑定农场");return}try{T.value=!0,console.log("第一步：更新土地信息...");const e={farm_id:Number(a),product_type:2,good_id:0,land_id:o.land_id||0,land:{id:o.id,land_id:o.land_id,land_name:o.land_name,land_tag:o.land_tag,area:o.area,price:o.price,sale_status:o.sale_status,sale_time:o.sale_time,detail:o.detail,image_urls:[],del_state:0,del_time:"",create_time:"",farm_id:Number(a)},good:{id:0,del_state:0,del_time:"",create_time:"",good_id:0,good_tag:"",good_name:"",farm_id:Number(a),image_urls:[],price:0,units:"",repertory:0,detail:""}},t=await ye(e);if(t.code===200||t.Code===200){if(console.log("第一步成功，准备上传图片..."),b.value&&b.value.length>0){console.log("第二步：上传土地图片，land_id:",o.land_id);try{await H(Number(a),o.land_id||0,b.value),c.success("土地信息修改并上传图片成功！")}catch(s){console.error("图片上传失败:",s),c.warning("土地信息修改成功，但部分图片上传失败")}}else c.success(t.msg||t.Msg||"修改成功");V.value=!1,D()}else c.error(t.msg||t.Msg||"修改失败")}catch(e){console.error("修改失败:",e),c.error("修改失败")}finally{T.value=!1}},G=()=>{_.currentPage=1},K=()=>{f.landId="",f.landName="",_.currentPage=1,D()},Q=a=>{_.pageSize=a,_.currentPage=1},X=a=>{_.currentPage=a},ee=async a=>{const e=F();if(!e){c.error("未找到农场信息，请先绑定农场");return}try{await Se.confirm("确定删除该土地资源吗？","提示",{type:"warning"})}catch{return}try{const t=await be({farm_id:Number(e),product_type:2,good_id:0,land_id:a.land_id??a.LandID??0});t.code===200||t.Code===200?(c.success(t.msg||t.Msg||"删除成功"),D()):c.error(t.msg||t.Msg||"删除失败")}catch(t){console.error("删除失败:",t),c.error("删除失败")}};return Ce(()=>{D(),$()}),(a,e)=>{const t=u("el-input"),s=u("ele-Search"),i=u("el-icon"),p=u("el-button"),m=u("ele-Refresh"),r=u("el-table-column"),y=u("el-link"),B=u("el-tag"),ae=u("el-divider"),le=u("el-table"),v=u("el-form-item"),te=u("el-option"),ne=u("el-select"),oe=u("el-input-number"),re=u("el-switch"),se=u("el-date-picker"),de=u("ele-Plus"),ie=u("el-image"),ue=u("el-upload"),me=u("el-form"),ce=u("el-dialog"),pe=u("el-pagination"),_e=De("loading");return h(),z("div",Pe,[P("div",Ue,[P("div",xe,[l(t,{modelValue:f.landId,"onUpdate:modelValue":e[0]||(e[0]=n=>f.landId=n),size:"default",placeholder:"请输入土地ID",style:{"max-width":"180px"},clearable:""},{prepend:d(()=>[...e[13]||(e[13]=[g("土地ID",-1)])]),_:1},8,["modelValue"]),l(t,{modelValue:f.landName,"onUpdate:modelValue":e[1]||(e[1]=n=>f.landName=n),size:"default",placeholder:"请输入土地名称",style:{"max-width":"220px"},class:"ml10",clearable:""},{prepend:d(()=>[...e[14]||(e[14]=[g("土地名称",-1)])]),_:1},8,["modelValue"]),l(p,{size:"default",type:"primary",class:"ml10",onClick:G},{default:d(()=>[l(i,null,{default:d(()=>[l(s)]),_:1}),e[15]||(e[15]=g(" 查询 ",-1))]),_:1}),l(p,{size:"default",type:"success",class:"ml10",onClick:K},{default:d(()=>[l(i,null,{default:d(()=>[l(m)]),_:1}),e[16]||(e[16]=g(" 刷新 ",-1))]),_:1})]),Ne((h(),U(le,{data:L.value,style:{width:"100%"},border:"",stripe:""},{default:d(()=>[l(r,{type:"index",label:"序号",width:"60",align:"center"}),l(r,{prop:"land_id",label:"土地ID",width:"120",align:"center"},{default:d(n=>[l(y,{type:"primary"},{default:d(()=>[g(C(n.row.land_id),1)]),_:2},1024)]),_:1}),l(r,{label:"土地图片",width:"100",align:"center"},{default:d(n=>[l(Ve,{images:n.row.image_urls,width:"50px",height:"50px","show-controls":!0,"show-indicators":!1,"show-thumbnails":!1,"show-preview":!0,"border-radius":"4px"},null,8,["images"])]),_:1}),l(r,{prop:"land_name",label:"土地名称","min-width":"150","show-overflow-tooltip":""}),l(r,{prop:"land_tag",label:"标签",width:"140",align:"center"},{default:d(n=>[n.row.land_tag?(h(),U(B,{key:0,type:"info"},{default:d(()=>[g(C(n.row.land_tag),1)]),_:2},1024)):(h(),z("span",Me,"-"))]),_:1}),l(r,{prop:"area",label:"面积",width:"120",align:"center"}),l(r,{prop:"price",label:"价格",width:"120",align:"center"}),l(r,{prop:"sale_status",label:"上架状态",width:"100",align:"center"},{default:d(n=>[l(B,{type:n.row.sale_status===0?"success":"info"},{default:d(()=>[g(C(n.row.sale_status===0?"上架":"下架"),1)]),_:2},1032,["type"])]),_:1}),l(r,{label:"租赁时间剩余",width:"220",align:"center"},{default:d(n=>[g(C(j(n.row.sale_time)),1)]),_:1}),l(r,{prop:"create_time",label:"创建时间",width:"160",align:"center"},{default:d(n=>[g(C(O(n.row.create_time)),1)]),_:1}),l(r,{prop:"detail",label:"土地详情","min-width":"180","show-overflow-tooltip":""}),l(r,{label:"操作",width:"160",align:"center"},{default:d(n=>[l(p,{type:"primary",link:"",onClick:ge=>Z(n.row)},{default:d(()=>[...e[17]||(e[17]=[g("修改",-1)])]),_:2},1032,["onClick"]),l(ae,{direction:"vertical"}),l(p,{type:"danger",link:"",onClick:ge=>ee(n.row)},{default:d(()=>[...e[18]||(e[18]=[g("删除",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[_e,N.value]]),l(ce,{modelValue:V.value,"onUpdate:modelValue":e[10]||(e[10]=n=>V.value=n),title:"修改土地资源",width:"640px","destroy-on-close":""},{footer:d(()=>[l(p,{onClick:e[9]||(e[9]=n=>V.value=!1)},{default:d(()=>[...e[19]||(e[19]=[g("取消",-1)])]),_:1}),l(p,{type:"primary",loading:T.value,onClick:q},{default:d(()=>[...e[20]||(e[20]=[g("保存",-1)])]),_:1},8,["loading"])]),default:d(()=>[l(me,{model:o,"label-width":"100px"},{default:d(()=>[l(v,{label:"土地名称"},{default:d(()=>[l(t,{modelValue:o.land_name,"onUpdate:modelValue":e[2]||(e[2]=n=>o.land_name=n)},null,8,["modelValue"])]),_:1}),l(v,{label:"土地类目"},{default:d(()=>[l(ne,{modelValue:o.land_tag,"onUpdate:modelValue":e[3]||(e[3]=n=>o.land_tag=n),placeholder:"请选择土地类目",clearable:"",filterable:"",style:{width:"100%"}},{default:d(()=>[(h(!0),z(Te,null,ke(M.value,n=>(h(),U(te,{key:n.category_id,label:n.name,value:n.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(v,{label:"面积"},{default:d(()=>[l(t,{modelValue:o.area,"onUpdate:modelValue":e[4]||(e[4]=n=>o.area=n)},null,8,["modelValue"])]),_:1}),l(v,{label:"价格"},{default:d(()=>[l(oe,{modelValue:o.price,"onUpdate:modelValue":e[5]||(e[5]=n=>o.price=n),min:0,precision:2,step:.1},null,8,["modelValue"])]),_:1}),l(v,{label:"上架状态"},{default:d(()=>[l(re,{modelValue:o.sale_status,"onUpdate:modelValue":e[6]||(e[6]=n=>o.sale_status=n),"active-value":0,"inactive-value":1},null,8,["modelValue"])]),_:1}),l(v,{label:"租赁截止"},{default:d(()=>[l(se,{modelValue:o.sale_time,"onUpdate:modelValue":e[7]||(e[7]=n=>o.sale_time=n),type:"datetime",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),l(v,{label:"土地图片"},{default:d(()=>[l(ue,{"list-type":"picture-card",limit:9,"auto-upload":!1,"file-list":b.value,"on-change":J,"on-remove":W},{file:d(({file:n})=>[l(ie,{src:n.url,fit:"cover",style:{width:"100%",height:"100%"}},null,8,["src"])]),default:d(()=>[l(i,null,{default:d(()=>[l(de)]),_:1})]),_:1},8,["file-list"])]),_:1}),l(v,{label:"详情"},{default:d(()=>[l(t,{modelValue:o.detail,"onUpdate:modelValue":e[8]||(e[8]=n=>o.detail=n),type:"textarea",rows:4},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),P("div",Fe,[l(pe,{"current-page":_.currentPage,"onUpdate:currentPage":e[11]||(e[11]=n=>_.currentPage=n),"page-size":_.pageSize,"onUpdate:pageSize":e[12]||(e[12]=n=>_.pageSize=n),"page-sizes":[10,20,50,100],total:_.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Q,onCurrentChange:X},null,8,["current-page","page-size","total"])])])])}}}),Je=ze(Ee,[["__scopeId","data-v-06ba99d9"]]);export{Je as default};
