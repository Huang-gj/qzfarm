import{g as ie,u as ue,d as me}from"./product-D1Snqc4F.js";import{t as ce}from"./test-CTZaUsd0.js";import{b as ge,S as F}from"./index-uJp-ZfSa.js";import{I as pe}from"./index-B2JtjZyr.js";import{l as M,r as h,M as z,p as _e,w as fe,A as i,a5 as ve,O as E,C as D,H as t,D as d,P as V,F as ye,S as _,B,T as C,e as g,E as be}from"./.store-DdqHRk86.js";import{_ as he}from"./_plugin-vue_export-helper-DlAUqK2U.js";const we={class:"system-order-container layout-pd"},Ie={class:"system-order-search mb15"},Ve={key:1},Ce={class:"price-amount"},Se={class:"price-unit"},De={class:"system-order-pagination mt15"},ke=M({name:"productResource"}),Pe=M({...ke,setup(xe){const N=ge(),k=h(!1),w=h(!1),P=h(!1),r=z({id:0,good_id:0,good_name:"",good_tag:"",price:0,units:"",repertory:0,detail:"",image_urls:""});h("");const y=h([]),I=h([]),f=z({goodId:"",goodName:""}),c=z({currentPage:1,pageSize:20,total:0}),x=h([]),G=_e(()=>{let o=x.value;f.goodId&&(o=o.filter(s=>{var u;return(u=s.good_id)==null?void 0:u.toString().includes(f.goodId)})),f.goodName&&(o=o.filter(s=>(s.good_name||"").includes(f.goodName))),c.total=o.length;const e=(c.currentPage-1)*c.pageSize,a=e+c.pageSize;return o.slice(e,a)}),U=()=>{const o=F.get("farmInfo");if(o)return o.farm_id||o.FarmID||o.farmId||null;const e=N.getUserInfo;return(e==null?void 0:e.farm_id)||(e==null?void 0:e.FarmID)||(e==null?void 0:e.farmId)||null},R=async(o,e,a)=>{const s=[];for(const u of a)if(u.raw){const p=ce(u.raw,o,e,-1).then(m=>{console.log(`文件 ${u.name} 上传成功:`,m)}).catch(m=>{throw console.error(`文件 ${u.name} 上传失败:`,m),new Error(`文件 ${u.name} 上传失败`)});s.push(p)}await Promise.all(s)},S=async()=>{var o,e,a;try{k.value=!0;let s=null;const u=F.get("farmInfo");if(u&&(s=u.farm_id||u.FarmID||u.farmId),!s){const n=N.getUserInfo;s=(n==null?void 0:n.farm_id)||(n==null?void 0:n.FarmID)||(n==null?void 0:n.farmId)||null}if(!s){g.error("未找到农场信息，请先绑定农场");return}const p={product_type:1,farm_id:Number(s)};console.log("农产品资源管理-请求参数:",p);const m=await ie(p);if(console.log("农产品资源管理-接口响应:",m),(m.code===200||m.Code===200)&&(m.good||m.Good)){const n=m.good||m.Good||[];console.log("农产品资源管理-原始列表首条键名:",n!=null&&n[0]?Object.keys(n[0]):[]),console.log("农产品资源管理-原始列表首条(CreateTime?):",(o=n==null?void 0:n[0])==null?void 0:o.CreateTime,"create_time:",(e=n==null?void 0:n[0])==null?void 0:e.create_time,"createTime:",(a=n==null?void 0:n[0])==null?void 0:a.createTime),x.value=n.map(v=>({...v,create_time:v.create_time||v.CreateTime||v.createTime||"",good_tag:v.good_tag||v.GoodTag||v.goodTag||""})),console.log("农产品资源管理-资源数据(归一化后):",x.value),g.success("农产品资源加载成功")}else g.error(m.msg||m.Msg||"获取农产品资源失败")}catch(s){console.error("获取农产品资源失败:",s),g.error("获取农产品资源失败")}finally{k.value=!1}},$=o=>{if(!o)return"";try{return new Date(o).toLocaleString("zh-CN")}catch{return o}},O=o=>new Promise((e,a)=>{const s=new FileReader;s.onload=()=>e(String(s.result)),s.onerror=a,s.readAsDataURL(o)}),j=async(o,e)=>{if(y.value=e,o.raw){const a=await O(o.raw);I.value.push(a)}},A=(o,e)=>{y.value=e;const a=new Set((e||[]).map(s=>s.url).filter(Boolean));I.value=I.value.filter(s=>a.has(s)||s.startsWith("data:"))},H=o=>{r.id=o.id??o.ID??0,r.good_id=o.good_id??o.GoodID??0,r.good_name=o.good_name??o.GoodName??"",r.good_tag=o.good_tag??o.GoodTag??"",r.price=o.price??0,r.units=o.units??"",r.repertory=o.repertory??0,r.detail=o.detail??"",r.image_urls=o.image_urls??"";try{const e=o.image_urls?JSON.parse(o.image_urls):[];y.value=e.map((a,s)=>({name:`img_${s}`,url:a})),I.value=e.slice()}catch{y.value=[],I.value=[]}w.value=!0},J=async()=>{const o=U();if(!o){g.error("未找到农场信息，请先绑定农场");return}try{P.value=!0,console.log("第一步：更新农产品信息...");const e={farm_id:Number(o),product_type:1,good_id:r.good_id||0,land_id:0,good:{id:r.id,good_id:r.good_id,good_name:r.good_name,good_tag:r.good_tag,price:r.price,units:r.units,repertory:r.repertory,detail:r.detail,image_urls:[],del_state:0,del_time:"",create_time:"",farm_id:Number(o)},land:{id:0,del_state:0,del_time:"",create_time:"",land_id:0,farm_id:Number(o),land_name:"",land_tag:"",area:"",image_urls:[],price:0,detail:"",sale_status:0,sale_time:""}},a=await ue(e);if(a.code===200||a.Code===200){if(console.log("第一步成功，准备上传图片..."),y.value&&y.value.length>0){console.log("第二步：上传农产品图片，good_id:",r.good_id);try{await R(Number(o),r.good_id||0,y.value),g.success("农产品信息修改并上传图片成功！")}catch(s){console.error("图片上传失败:",s),g.warning("农产品信息修改成功，但部分图片上传失败")}}else g.success(a.msg||a.Msg||"修改成功");w.value=!1,S()}else g.error(a.msg||a.Msg||"修改失败")}catch(e){console.error("修改失败:",e),g.error("修改失败")}finally{P.value=!1}},W=()=>{c.currentPage=1},q=()=>{f.goodId="",f.goodName="",c.currentPage=1,S()},K=o=>{c.pageSize=o,c.currentPage=1},Q=o=>{c.currentPage=o},X=async o=>{const e=U();if(!e){g.error("未找到农场信息，请先绑定农场");return}try{await be.confirm("确定删除该农产品吗？","提示",{type:"warning"})}catch{return}try{const a=await me({farm_id:Number(e),product_type:1,good_id:o.good_id??o.GoodID??0,land_id:0});a.code===200||a.Code===200?(g.success(a.msg||a.Msg||"删除成功"),S()):g.error(a.msg||a.Msg||"删除失败")}catch(a){console.error("删除失败:",a),g.error("删除失败")}};return fe(()=>{S()}),(o,e)=>{const a=i("el-input"),s=i("ele-Search"),u=i("el-icon"),p=i("el-button"),m=i("ele-Refresh"),n=i("el-table-column"),v=i("el-link"),Y=i("el-tag"),Z=i("el-divider"),L=i("el-table"),b=i("el-form-item"),T=i("el-input-number"),ee=i("ele-Plus"),oe=i("el-image"),te=i("el-upload"),le=i("el-form"),ae=i("el-dialog"),ne=i("el-pagination"),re=i("el-card"),de=ve("loading");return D(),E("div",we,[t(re,{shadow:"hover"},{default:d(()=>[V("div",Ie,[t(a,{modelValue:f.goodId,"onUpdate:modelValue":e[0]||(e[0]=l=>f.goodId=l),size:"default",placeholder:"请输入商品ID",style:{"max-width":"180px"},clearable:""},{prepend:d(()=>[...e[12]||(e[12]=[_("商品ID",-1)])]),_:1},8,["modelValue"]),t(a,{modelValue:f.goodName,"onUpdate:modelValue":e[1]||(e[1]=l=>f.goodName=l),size:"default",placeholder:"请输入商品名称",style:{"max-width":"220px"},class:"ml10",clearable:""},{prepend:d(()=>[...e[13]||(e[13]=[_("商品名称",-1)])]),_:1},8,["modelValue"]),t(p,{size:"default",type:"primary",class:"ml10",onClick:W},{default:d(()=>[t(u,null,{default:d(()=>[t(s)]),_:1}),e[14]||(e[14]=_(" 查询 ",-1))]),_:1}),t(p,{size:"default",type:"success",class:"ml10",onClick:q},{default:d(()=>[t(u,null,{default:d(()=>[t(m)]),_:1}),e[15]||(e[15]=_(" 刷新 ",-1))]),_:1})]),ye((D(),B(L,{data:G.value,style:{width:"100%"},border:"",stripe:""},{default:d(()=>[t(n,{type:"index",label:"序号",width:"60",align:"center"}),t(n,{prop:"good_id",label:"商品ID",width:"120",align:"center"},{default:d(l=>[t(v,{type:"primary"},{default:d(()=>[_(C(l.row.good_id),1)]),_:2},1024)]),_:1}),t(n,{label:"商品图片",width:"100",align:"center"},{default:d(l=>[t(pe,{images:l.row.image_urls,width:"50px",height:"50px","show-controls":!0,"show-indicators":!1,"show-thumbnails":!1,"show-preview":!0,"border-radius":"4px"},null,8,["images"])]),_:1}),t(n,{prop:"good_name",label:"商品名称","min-width":"150","show-overflow-tooltip":""}),t(n,{prop:"good_tag",label:"标签",width:"140",align:"center"},{default:d(l=>[l.row.good_tag?(D(),B(Y,{key:0,type:"info"},{default:d(()=>[_(C(l.row.good_tag),1)]),_:2},1024)):(D(),E("span",Ve,"-"))]),_:1}),t(n,{label:"价格/单位",width:"140",align:"center"},{default:d(l=>[V("div",null,[V("div",Ce,"¥"+C(l.row.price),1),V("div",Se,C(l.row.units),1)])]),_:1}),t(n,{prop:"repertory",label:"库存",width:"100",align:"center"}),t(n,{prop:"create_time",label:"创建时间",width:"160",align:"center"},{default:d(l=>[_(C($(l.row.create_time)),1)]),_:1}),t(n,{prop:"detail",label:"商品详情","min-width":"180","show-overflow-tooltip":""}),t(n,{label:"操作",width:"160",align:"center"},{default:d(l=>[t(p,{type:"primary",link:"",onClick:se=>H(l.row)},{default:d(()=>[...e[16]||(e[16]=[_("修改",-1)])]),_:2},1032,["onClick"]),t(Z,{direction:"vertical"}),t(p,{type:"danger",link:"",onClick:se=>X(l.row)},{default:d(()=>[...e[17]||(e[17]=[_("删除",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[de,k.value]]),t(ae,{modelValue:w.value,"onUpdate:modelValue":e[9]||(e[9]=l=>w.value=l),title:"修改农产品资源",width:"640px","destroy-on-close":""},{footer:d(()=>[t(p,{onClick:e[8]||(e[8]=l=>w.value=!1)},{default:d(()=>[...e[18]||(e[18]=[_("取消",-1)])]),_:1}),t(p,{type:"primary",loading:P.value,onClick:J},{default:d(()=>[...e[19]||(e[19]=[_("保存",-1)])]),_:1},8,["loading"])]),default:d(()=>[t(le,{model:r,"label-width":"100px"},{default:d(()=>[t(b,{label:"商品名称"},{default:d(()=>[t(a,{modelValue:r.good_name,"onUpdate:modelValue":e[2]||(e[2]=l=>r.good_name=l)},null,8,["modelValue"])]),_:1}),t(b,{label:"标签"},{default:d(()=>[t(a,{modelValue:r.good_tag,"onUpdate:modelValue":e[3]||(e[3]=l=>r.good_tag=l)},null,8,["modelValue"])]),_:1}),t(b,{label:"价格"},{default:d(()=>[t(T,{modelValue:r.price,"onUpdate:modelValue":e[4]||(e[4]=l=>r.price=l),min:0,precision:2,step:.1},null,8,["modelValue"])]),_:1}),t(b,{label:"单位"},{default:d(()=>[t(a,{modelValue:r.units,"onUpdate:modelValue":e[5]||(e[5]=l=>r.units=l)},null,8,["modelValue"])]),_:1}),t(b,{label:"库存"},{default:d(()=>[t(T,{modelValue:r.repertory,"onUpdate:modelValue":e[6]||(e[6]=l=>r.repertory=l),min:0,step:1},null,8,["modelValue"])]),_:1}),t(b,{label:"商品图片"},{default:d(()=>[t(te,{"list-type":"picture-card",limit:9,"auto-upload":!1,"file-list":y.value,"on-change":j,"on-remove":A},{file:d(({file:l})=>[t(oe,{src:l.url,fit:"cover",style:{width:"100%",height:"100%"}},null,8,["src"])]),default:d(()=>[t(u,null,{default:d(()=>[t(ee)]),_:1})]),_:1},8,["file-list"])]),_:1}),t(b,{label:"详情"},{default:d(()=>[t(a,{modelValue:r.detail,"onUpdate:modelValue":e[7]||(e[7]=l=>r.detail=l),type:"textarea",rows:4},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),V("div",De,[t(ne,{"current-page":c.currentPage,"onUpdate:currentPage":e[10]||(e[10]=l=>c.currentPage=l),"page-size":c.pageSize,"onUpdate:pageSize":e[11]||(e[11]=l=>c.pageSize=l),"page-sizes":[10,20,50,100],total:c.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:K,onCurrentChange:Q},null,8,["current-page","page-size","total"])])]),_:1})])}}}),Be=he(Pe,[["__scopeId","data-v-e4724fd6"]]);export{Be as default};
