import{g as ce,u as pe,d as _e}from"./product-D1Snqc4F.js";import{t as ge}from"./test-CTZaUsd0.js";import{b as fe,S as F}from"./index-uJp-ZfSa.js";import{I as ye}from"./index-B2JtjZyr.js";import{l as B,r as w,M as k,p as ve,w as be,A as m,a5 as we,O as $,C,P as z,F as he,H as l,D as d,S as g,B as E,T as I,e as _,E as Ve}from"./.store-DdqHRk86.js";import{_ as Ie}from"./_plugin-vue_export-helper-DlAUqK2U.js";const De={class:"system-land-resource-container layout-padding"},Ce={class:"system-land-resource-padding layout-padding-auto layout-padding-view"},Ne={class:"system-land-resource-search mb15"},Se={key:1},Te={class:"system-land-resource-pagination mt15"},ke=B({name:"landResource"}),ze=B({...ke,setup(Pe){const P=fe(),N=w(!1),h=w(!1),S=w(!1),o=k({id:0,land_id:0,land_name:"",land_tag:"",area:"",price:0,sale_status:0,sale_time:"",detail:"",image_urls:""}),v=w([]),V=w([]),f=k({landId:"",landName:""}),p=k({currentPage:1,pageSize:20,total:0}),T=w([]),R=ve(()=>{let a=T.value;f.landId&&(a=a.filter(s=>{var i;return(i=s.land_id)==null?void 0:i.toString().includes(f.landId)})),f.landName&&(a=a.filter(s=>(s.land_name||"").includes(f.landName))),p.total=a.length;const e=(p.currentPage-1)*p.pageSize,t=e+p.pageSize;return a.slice(e,t)}),U=()=>{const a=F.get("farmInfo");if(a)return a.farm_id||a.FarmID||a.farmId||null;const e=P.getUserInfo;return(e==null?void 0:e.farm_id)||(e==null?void 0:e.FarmID)||(e==null?void 0:e.farmId)||null},Y=async(a,e,t)=>{const s=[];for(const i of t)if(i.raw){const c=ge(i.raw,a,-1,e).then(u=>{console.log(`文件 ${i.name} 上传成功:`,u)}).catch(u=>{throw console.error(`文件 ${i.name} 上传失败:`,u),new Error(`文件 ${i.name} 上传失败`)});s.push(c)}await Promise.all(s)},D=async()=>{var a,e,t;try{N.value=!0;let s=null;const i=F.get("farmInfo");if(i&&(s=i.farm_id||i.FarmID||i.farmId),!s){const r=P.getUserInfo;s=(r==null?void 0:r.farm_id)||(r==null?void 0:r.FarmID)||(r==null?void 0:r.farmId)||null}if(!s){_.error("未找到农场信息，请先绑定农场");return}const c={product_type:2,farm_id:Number(s)};console.log("土地资源管理-请求参数:",c);const u=await ce(c);if(console.log("土地资源管理-接口响应:",u),(u.code===200||u.Code===200)&&(u.land||u.Land)){const r=u.land||u.Land||[];console.log("土地资源管理-原始列表首条键名:",r!=null&&r[0]?Object.keys(r[0]):[]),console.log("土地资源管理-原始列表首条(CreateTime?):",(a=r==null?void 0:r[0])==null?void 0:a.CreateTime,"create_time:",(e=r==null?void 0:r[0])==null?void 0:e.create_time,"createTime:",(t=r==null?void 0:r[0])==null?void 0:t.createTime),T.value=r.map(y=>({...y,create_time:y.create_time||y.CreateTime||y.createTime||"",land_tag:y.land_tag||y.LandTag||y.landTag||""})),console.log("土地资源管理-资源数据(归一化后):",T.value),_.success("土地资源加载成功")}else _.error(u.msg||u.Msg||"获取土地资源失败")}catch(s){console.error("获取土地资源失败:",s),_.error("获取土地资源失败")}finally{N.value=!1}},H=a=>{if(!a)return"";const e=x(a);return e?e.toLocaleString("zh-CN"):a},x=a=>{if(a==null)return null;if(typeof a=="number"){const e=a>1e12?a:a*1e3,t=new Date(e);return isNaN(t.getTime())?null:t}if(typeof a=="string"){const e=a.trim();if(!e)return null;const t=Number(e);if(!isNaN(t)){const c=t>1e12?t:t*1e3,u=new Date(c);return isNaN(u.getTime())?null:u}const s=e.replace(/-/g,"/").replace("T"," ").replace(/Z$/i,""),i=new Date(s);return isNaN(i.getTime())?null:i}return null},L=a=>{const e=x(a);if(!e)return"租赁时间剩余：0天0小时0分钟";let t=e.getTime()-Date.now();if(t<=0)return"租赁时间剩余：0天0小时0分钟";const s=Math.floor(t/6e4),i=Math.floor(s/(60*24)),c=Math.floor(s%(60*24)/60),u=s%60;return`租赁时间剩余：${i}天${c}小时${u}分钟`},O=a=>new Promise((e,t)=>{const s=new FileReader;s.onload=()=>e(String(s.result)),s.onerror=t,s.readAsDataURL(a)}),j=async(a,e)=>{if(v.value=e,a.raw){const t=await O(a.raw);V.value.push(t)}},A=(a,e)=>{v.value=e;const t=new Set((e||[]).map(s=>s.url).filter(Boolean));V.value=V.value.filter(s=>t.has(s)||s.startsWith("data:"))},J=a=>{o.id=a.id??a.ID??0,o.land_id=a.land_id??a.LandID??0,o.land_name=a.land_name??a.LandName??"",o.land_tag=a.land_tag??a.LandTag??"",o.area=a.area??"",o.price=a.price??0,o.sale_status=a.sale_status??0,o.sale_time=a.sale_time??"",o.detail=a.detail??"",o.image_urls=a.image_urls??"";try{const e=a.image_urls?JSON.parse(a.image_urls):[];v.value=e.map((t,s)=>({name:`img_${s}`,url:t})),V.value=e.slice()}catch{v.value=[],V.value=[]}h.value=!0},W=async()=>{const a=U();if(!a){_.error("未找到农场信息，请先绑定农场");return}try{S.value=!0,console.log("第一步：更新土地信息...");const e={farm_id:Number(a),product_type:2,good_id:0,land_id:o.land_id||0,land:{id:o.id,land_id:o.land_id,land_name:o.land_name,land_tag:o.land_tag,area:o.area,price:o.price,sale_status:o.sale_status,sale_time:o.sale_time,detail:o.detail,image_urls:[],del_state:0,del_time:"",create_time:"",farm_id:Number(a)},good:{id:0,del_state:0,del_time:"",create_time:"",good_id:0,good_tag:"",good_name:"",farm_id:Number(a),image_urls:[],price:0,units:"",repertory:0,detail:""}},t=await pe(e);if(t.code===200||t.Code===200){if(console.log("第一步成功，准备上传图片..."),v.value&&v.value.length>0){console.log("第二步：上传土地图片，land_id:",o.land_id);try{await Y(Number(a),o.land_id||0,v.value),_.success("土地信息修改并上传图片成功！")}catch(s){console.error("图片上传失败:",s),_.warning("土地信息修改成功，但部分图片上传失败")}}else _.success(t.msg||t.Msg||"修改成功");h.value=!1,D()}else _.error(t.msg||t.Msg||"修改失败")}catch(e){console.error("修改失败:",e),_.error("修改失败")}finally{S.value=!1}},Z=()=>{p.currentPage=1},q=()=>{f.landId="",f.landName="",p.currentPage=1,D()},G=a=>{p.pageSize=a,p.currentPage=1},K=a=>{p.currentPage=a},Q=async a=>{const e=U();if(!e){_.error("未找到农场信息，请先绑定农场");return}try{await Ve.confirm("确定删除该土地资源吗？","提示",{type:"warning"})}catch{return}try{const t=await _e({farm_id:Number(e),product_type:2,good_id:0,land_id:a.land_id??a.LandID??0});t.code===200||t.Code===200?(_.success(t.msg||t.Msg||"删除成功"),D()):_.error(t.msg||t.Msg||"删除失败")}catch(t){console.error("删除失败:",t),_.error("删除失败")}};return be(()=>{D()}),(a,e)=>{const t=m("el-input"),s=m("ele-Search"),i=m("el-icon"),c=m("el-button"),u=m("ele-Refresh"),r=m("el-table-column"),y=m("el-link"),M=m("el-tag"),X=m("el-divider"),ee=m("el-table"),b=m("el-form-item"),ae=m("el-input-number"),le=m("el-switch"),te=m("el-date-picker"),ne=m("ele-Plus"),oe=m("el-image"),re=m("el-upload"),se=m("el-form"),de=m("el-dialog"),ie=m("el-pagination"),ue=we("loading");return C(),$("div",De,[z("div",Ce,[z("div",Ne,[l(t,{modelValue:f.landId,"onUpdate:modelValue":e[0]||(e[0]=n=>f.landId=n),size:"default",placeholder:"请输入土地ID",style:{"max-width":"180px"},clearable:""},{prepend:d(()=>[...e[13]||(e[13]=[g("土地ID",-1)])]),_:1},8,["modelValue"]),l(t,{modelValue:f.landName,"onUpdate:modelValue":e[1]||(e[1]=n=>f.landName=n),size:"default",placeholder:"请输入土地名称",style:{"max-width":"220px"},class:"ml10",clearable:""},{prepend:d(()=>[...e[14]||(e[14]=[g("土地名称",-1)])]),_:1},8,["modelValue"]),l(c,{size:"default",type:"primary",class:"ml10",onClick:Z},{default:d(()=>[l(i,null,{default:d(()=>[l(s)]),_:1}),e[15]||(e[15]=g(" 查询 ",-1))]),_:1}),l(c,{size:"default",type:"success",class:"ml10",onClick:q},{default:d(()=>[l(i,null,{default:d(()=>[l(u)]),_:1}),e[16]||(e[16]=g(" 刷新 ",-1))]),_:1})]),he((C(),E(ee,{data:R.value,style:{width:"100%"},border:"",stripe:""},{default:d(()=>[l(r,{type:"index",label:"序号",width:"60",align:"center"}),l(r,{prop:"land_id",label:"土地ID",width:"120",align:"center"},{default:d(n=>[l(y,{type:"primary"},{default:d(()=>[g(I(n.row.land_id),1)]),_:2},1024)]),_:1}),l(r,{label:"土地图片",width:"100",align:"center"},{default:d(n=>[l(ye,{images:n.row.image_urls,width:"50px",height:"50px","show-controls":!0,"show-indicators":!1,"show-thumbnails":!1,"show-preview":!0,"border-radius":"4px"},null,8,["images"])]),_:1}),l(r,{prop:"land_name",label:"土地名称","min-width":"150","show-overflow-tooltip":""}),l(r,{prop:"land_tag",label:"标签",width:"140",align:"center"},{default:d(n=>[n.row.land_tag?(C(),E(M,{key:0,type:"info"},{default:d(()=>[g(I(n.row.land_tag),1)]),_:2},1024)):(C(),$("span",Se,"-"))]),_:1}),l(r,{prop:"area",label:"面积",width:"120",align:"center"}),l(r,{prop:"price",label:"价格",width:"120",align:"center"}),l(r,{prop:"sale_status",label:"上架状态",width:"100",align:"center"},{default:d(n=>[l(M,{type:n.row.sale_status===0?"success":"info"},{default:d(()=>[g(I(n.row.sale_status===0?"上架":"下架"),1)]),_:2},1032,["type"])]),_:1}),l(r,{label:"租赁时间剩余",width:"220",align:"center"},{default:d(n=>[g(I(L(n.row.sale_time)),1)]),_:1}),l(r,{prop:"create_time",label:"创建时间",width:"160",align:"center"},{default:d(n=>[g(I(H(n.row.create_time)),1)]),_:1}),l(r,{prop:"detail",label:"土地详情","min-width":"180","show-overflow-tooltip":""}),l(r,{label:"操作",width:"160",align:"center"},{default:d(n=>[l(c,{type:"primary",link:"",onClick:me=>J(n.row)},{default:d(()=>[...e[17]||(e[17]=[g("修改",-1)])]),_:2},1032,["onClick"]),l(X,{direction:"vertical"}),l(c,{type:"danger",link:"",onClick:me=>Q(n.row)},{default:d(()=>[...e[18]||(e[18]=[g("删除",-1)])]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[ue,N.value]]),l(de,{modelValue:h.value,"onUpdate:modelValue":e[10]||(e[10]=n=>h.value=n),title:"修改土地资源",width:"640px","destroy-on-close":""},{footer:d(()=>[l(c,{onClick:e[9]||(e[9]=n=>h.value=!1)},{default:d(()=>[...e[19]||(e[19]=[g("取消",-1)])]),_:1}),l(c,{type:"primary",loading:S.value,onClick:W},{default:d(()=>[...e[20]||(e[20]=[g("保存",-1)])]),_:1},8,["loading"])]),default:d(()=>[l(se,{model:o,"label-width":"100px"},{default:d(()=>[l(b,{label:"土地名称"},{default:d(()=>[l(t,{modelValue:o.land_name,"onUpdate:modelValue":e[2]||(e[2]=n=>o.land_name=n)},null,8,["modelValue"])]),_:1}),l(b,{label:"标签"},{default:d(()=>[l(t,{modelValue:o.land_tag,"onUpdate:modelValue":e[3]||(e[3]=n=>o.land_tag=n)},null,8,["modelValue"])]),_:1}),l(b,{label:"面积"},{default:d(()=>[l(t,{modelValue:o.area,"onUpdate:modelValue":e[4]||(e[4]=n=>o.area=n)},null,8,["modelValue"])]),_:1}),l(b,{label:"价格"},{default:d(()=>[l(ae,{modelValue:o.price,"onUpdate:modelValue":e[5]||(e[5]=n=>o.price=n),min:0,precision:2,step:.1},null,8,["modelValue"])]),_:1}),l(b,{label:"上架状态"},{default:d(()=>[l(le,{modelValue:o.sale_status,"onUpdate:modelValue":e[6]||(e[6]=n=>o.sale_status=n),"active-value":0,"inactive-value":1},null,8,["modelValue"])]),_:1}),l(b,{label:"租赁截止"},{default:d(()=>[l(te,{modelValue:o.sale_time,"onUpdate:modelValue":e[7]||(e[7]=n=>o.sale_time=n),type:"datetime",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),l(b,{label:"土地图片"},{default:d(()=>[l(re,{"list-type":"picture-card",limit:9,"auto-upload":!1,"file-list":v.value,"on-change":j,"on-remove":A},{file:d(({file:n})=>[l(oe,{src:n.url,fit:"cover",style:{width:"100%",height:"100%"}},null,8,["src"])]),default:d(()=>[l(i,null,{default:d(()=>[l(ne)]),_:1})]),_:1},8,["file-list"])]),_:1}),l(b,{label:"详情"},{default:d(()=>[l(t,{modelValue:o.detail,"onUpdate:modelValue":e[8]||(e[8]=n=>o.detail=n),type:"textarea",rows:4},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),z("div",Te,[l(ie,{"current-page":p.currentPage,"onUpdate:currentPage":e[11]||(e[11]=n=>p.currentPage=n),"page-size":p.pageSize,"onUpdate:pageSize":e[12]||(e[12]=n=>p.pageSize=n),"page-sizes":[10,20,50,100],total:p.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:G,onCurrentChange:K},null,8,["current-page","page-size","total"])])])])}}}),Be=Ie(ze,[["__scopeId","data-v-8d70982c"]]);export{Be as default};
