import{a as z}from"./product-DxidGg0o.js";import{g as O}from"./category-DcVo9en5.js";import{b as Z,S as j}from"./index-Bt6IFO1h.js";import{l as q,Z as G,r as p,M as J,w as K,A as s,O as k,C as g,H as t,D as n,P as y,$ as Q,a0 as W,B as X,S as _,e as i}from"./.store-D3f7YvtR.js";import{t as ee}from"./test-C0kB_yHp.js";import{_ as le}from"./_plugin-vue_export-helper-DlAUqK2U.js";const te={class:"land-add-container layout-pd"},ae={class:"mt5"},oe={class:"mt15"},ne=q({__name:"resource-add",setup(re){const C=Z(),I=G(),U=p(),c=p(!1),b=p([]),l=J({land_name:"",land_tag:"",area:"",price:0,sale_status:0,sale_time:"",detail:"",fileList:[]}),v=()=>{l.land_name="",l.land_tag="",l.area="",l.price=0,l.sale_status=0,l.sale_time="",l.detail="",l.fileList=[]},L=async()=>{try{const a=await O({categoryType:2});a.code===200?b.value=a.category||[]:i.warning(a.msg||"获取类目列表失败")}catch(a){console.error("获取类目列表失败:",a),i.error("获取类目列表失败")}},h=()=>{I.push("/params/category/add")},x=()=>{const a=j.get("farmInfo");if(a)return a.farm_id||a.FarmID||a.farmId||null;const e=C.getUserInfo;return(e==null?void 0:e.farm_id)||(e==null?void 0:e.FarmID)||(e==null?void 0:e.farmId)||null},M=async(a,e,r)=>{const d=[];for(const m of r)if(m.raw){const f=ee(m.raw,a,-1,e).then(u=>{console.log(`文件 ${m.name} 上传成功:`,u)}).catch(u=>{throw console.error(`文件 ${m.name} 上传失败:`,u),new Error(`文件 ${m.name} 上传失败`)});d.push(f)}await Promise.all(d)},D=(a,e)=>{l.fileList=e},F=(a,e)=>{l.fileList=e},Y=()=>{var a,e;return(a=l.land_name)!=null&&a.trim()?(e=l.area)!=null&&e.trim()?l.price===null||l.price===void 0?(i.error("请填写价格"),!1):!0:(i.error("请填写面积"),!1):(i.error("请填写土地名称"),!1)},P=async()=>{if(!Y())return;const a=x();if(!a){i.error("未找到农场信息，请先绑定农场");return}const e={product_type:2,farm_id:Number(a),good_id:0,land_id:0,land:{id:0,del_state:0,del_time:"",create_time:"",land_id:0,farm_id:Number(a),land_name:l.land_name,land_tag:l.land_tag,area:l.area,price:l.price,sale_status:l.sale_status,sale_time:l.sale_time||"",detail:l.detail,image_urls:[]},good:{id:0,del_state:0,del_time:"",create_time:"",good_id:0,good_tag:"",good_name:"",farm_id:Number(a),image_urls:[],price:0,units:"",repertory:0,detail:""}};try{c.value=!0,console.log("第一步：创建土地记录...",e);const r=await z(e);if(console.log("第一步成功，获取到的响应:",r),r.code===200||r.Code===200){if(r.land_id){console.log("第二步：上传土地图片，land_id:",r.land_id);try{l.fileList&&l.fileList.length>0&&(console.log("上传土地图片..."),await M(a,r.land_id,l.fileList)),i.success("土地创建并上传图片成功！")}catch(d){console.error("文件上传失败:",d),i.warning("土地创建成功，但部分图片上传失败")}}else console.warn("未获取到land_id，跳过文件上传"),i.success(r.msg||r.Msg||"新增成功");v()}else i.error(r.msg||r.Msg||"新增失败")}catch(r){console.error("新增失败:",r),i.error("新增失败")}finally{c.value=!1}};return K(()=>{L()}),(a,e)=>{const r=s("el-input"),d=s("el-form-item"),m=s("el-option"),f=s("el-select"),u=s("el-link"),B=s("el-text"),N=s("el-input-number"),S=s("el-switch"),H=s("el-date-picker"),E=s("ele-Plus"),R=s("el-icon"),T=s("el-image"),$=s("el-upload"),V=s("el-card"),A=s("el-form"),w=s("el-button");return g(),k("div",te,[t(V,{shadow:"hover"},{default:n(()=>[e[11]||(e[11]=y("div",{class:"mb15"},"新增土地资源",-1)),t(A,{ref_key:"formRef",ref:U,"label-width":"110px"},{default:n(()=>[t(V,{class:"mb15",shadow:"never"},{default:n(()=>[t(d,{label:"土地名称"},{default:n(()=>[t(r,{modelValue:l.land_name,"onUpdate:modelValue":e[0]||(e[0]=o=>l.land_name=o),placeholder:"请输入",clearable:""},null,8,["modelValue"])]),_:1}),t(d,{label:"土地类目"},{default:n(()=>[t(f,{modelValue:l.land_tag,"onUpdate:modelValue":e[1]||(e[1]=o=>l.land_tag=o),placeholder:"请选择土地类目",clearable:"",filterable:"",style:{width:"100%"}},{default:n(()=>[(g(!0),k(Q,null,W(b.value,o=>(g(),X(m,{key:o.category_id,label:o.name,value:o.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),y("div",ae,[t(B,{size:"small",type:"info"},{default:n(()=>[e[8]||(e[8]=_(" 没有合适的类目？ ",-1)),t(u,{type:"primary",onClick:h},{default:n(()=>[...e[7]||(e[7]=[_("点击新增类目",-1)])]),_:1})]),_:1})])]),_:1}),t(d,{label:"面积"},{default:n(()=>[t(r,{modelValue:l.area,"onUpdate:modelValue":e[2]||(e[2]=o=>l.area=o),placeholder:"请输入面积",clearable:""},null,8,["modelValue"])]),_:1}),t(d,{label:"价格"},{default:n(()=>[t(N,{modelValue:l.price,"onUpdate:modelValue":e[3]||(e[3]=o=>l.price=o),min:0,precision:2,step:.1},null,8,["modelValue"])]),_:1}),t(d,{label:"上架状态"},{default:n(()=>[t(S,{modelValue:l.sale_status,"onUpdate:modelValue":e[4]||(e[4]=o=>l.sale_status=o),"active-value":0,"inactive-value":1},null,8,["modelValue"])]),_:1}),t(d,{label:"租赁截止"},{default:n(()=>[t(H,{modelValue:l.sale_time,"onUpdate:modelValue":e[5]||(e[5]=o=>l.sale_time=o),type:"datetime",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",placeholder:"请选择租赁截止时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(d,{label:"土地图片"},{default:n(()=>[t($,{"list-type":"picture-card",limit:9,"auto-upload":!1,"file-list":l.fileList,"on-change":D,"on-remove":F},{file:n(({file:o})=>[t(T,{src:o.url,fit:"cover",style:{width:"100%",height:"100%"}},null,8,["src"])]),default:n(()=>[t(R,null,{default:n(()=>[t(E)]),_:1})]),_:1},8,["file-list"])]),_:1}),t(d,{label:"详情"},{default:n(()=>[t(r,{modelValue:l.detail,"onUpdate:modelValue":e[6]||(e[6]=o=>l.detail=o),type:"textarea",rows:4,placeholder:"请输入详情"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512),y("div",oe,[t(w,{type:"primary",loading:c.value,onClick:P},{default:n(()=>[...e[9]||(e[9]=[_("提交",-1)])]),_:1},8,["loading"]),t(w,{onClick:v},{default:n(()=>[...e[10]||(e[10]=[_("重置",-1)])]),_:1})])]),_:1})])}}}),ce=le(ne,[["__scopeId","data-v-88a9de80"]]);export{ce as default};
