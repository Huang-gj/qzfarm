import{a as S}from"./product-DbVt4hIS.js";import{b as B,S as D}from"./index-ehGYOv3s.js";import{t as E}from"./test-CeED8DGd.js";import{l as v,r as b,M,A as s,O as R,C as A,H as l,D as a,P as y,S as V,e as i}from"./.store-CUxRj2E2.js";import{_ as $}from"./_plugin-vue_export-helper-DlAUqK2U.js";const T={class:"product-add-container layout-pd"},H={class:"mt15"},O=v({name:"productResourceAdd"}),j=v({...O,setup(q){const w=B(),I=b(),c=b(!1),o=M({good_name:"",good_tag:"",price:0,units:"",repertory:0,detail:"",fileList:[]}),f=()=>{o.good_name="",o.good_tag="",o.price=0,o.units="",o.repertory=0,o.detail="",o.fileList=[]},U=()=>{const r=D.get("farmInfo");if(r)return r.farm_id||r.FarmID||r.farmId||null;const e=w.getUserInfo;return(e==null?void 0:e.farm_id)||(e==null?void 0:e.FarmID)||(e==null?void 0:e.farmId)||null},C=async(r,e,t)=>{const d=[];for(const m of t)if(m.raw){const _=E(m.raw,r,e,-1).then(u=>{console.log(`文件 ${m.name} 上传成功:`,u)}).catch(u=>{throw console.error(`文件 ${m.name} 上传失败:`,u),new Error(`文件 ${m.name} 上传失败`)});d.push(_)}await Promise.all(d)},L=(r,e)=>{o.fileList=e},h=(r,e)=>{o.fileList=e},x=()=>{var r,e;return(r=o.good_name)!=null&&r.trim()?o.price===null||o.price===void 0?(i.error("请填写价格"),!1):(e=o.units)!=null&&e.trim()?o.repertory===null||o.repertory===void 0?(i.error("请填写库存"),!1):!0:(i.error("请填写单位"),!1):(i.error("请填写商品名称"),!1)},F=async()=>{if(!x())return;const r=U();if(!r){i.error("未找到农场信息，请先绑定农场");return}const e={product_type:1,farm_id:Number(r),good_id:0,land_id:0,good:{id:0,del_state:0,del_time:"",create_time:"",good_id:0,farm_id:Number(r),good_name:o.good_name,good_tag:o.good_tag,price:o.price,units:o.units,repertory:o.repertory,detail:o.detail,image_urls:[]},land:{id:0,del_state:0,del_time:"",create_time:"",land_id:0,farm_id:Number(r),land_name:"",land_tag:"",area:"",image_urls:[],price:0,detail:"",sale_status:0,sale_time:""}};try{c.value=!0,console.log("第一步：创建商品记录...");const t=await S(e);if(t.code===200||t.Code===200){if(console.log("第一步成功，获取到的响应:",t),t.good_id){console.log("第二步：上传商品图片，good_id:",t.good_id);try{o.fileList&&o.fileList.length>0&&(console.log("上传商品图片..."),await C(r,t.good_id,o.fileList)),i.success("商品创建并上传图片成功！")}catch(d){console.error("文件上传失败:",d),i.warning("商品创建成功，但部分图片上传失败")}}else console.warn("未获取到good_id，跳过文件上传"),i.success(t.msg||t.Msg||"新增成功");f()}else i.error(t.msg||t.Msg||"新增失败")}catch(t){console.error("新增失败:",t),i.error("新增失败")}finally{c.value=!1}};return(r,e)=>{const t=s("el-input"),d=s("el-form-item"),m=s("el-input-number"),_=s("ele-Plus"),u=s("el-icon"),P=s("el-image"),k=s("el-upload"),p=s("el-card"),N=s("el-form"),g=s("el-button");return A(),R("div",T,[l(p,{shadow:"hover"},{default:a(()=>[e[8]||(e[8]=y("div",{class:"mb15"},"新增农产品资源",-1)),l(N,{ref_key:"formRef",ref:I,"label-width":"110px"},{default:a(()=>[l(p,{class:"mb15",shadow:"never"},{default:a(()=>[l(d,{label:"商品名称"},{default:a(()=>[l(t,{modelValue:o.good_name,"onUpdate:modelValue":e[0]||(e[0]=n=>o.good_name=n),placeholder:"请输入",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{label:"标签"},{default:a(()=>[l(t,{modelValue:o.good_tag,"onUpdate:modelValue":e[1]||(e[1]=n=>o.good_tag=n),placeholder:"",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{label:"价格"},{default:a(()=>[l(m,{modelValue:o.price,"onUpdate:modelValue":e[2]||(e[2]=n=>o.price=n),min:0,precision:2,step:.1},null,8,["modelValue"])]),_:1}),l(d,{label:"单位"},{default:a(()=>[l(t,{modelValue:o.units,"onUpdate:modelValue":e[3]||(e[3]=n=>o.units=n),placeholder:"个/斤/千克等",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{label:"库存"},{default:a(()=>[l(m,{modelValue:o.repertory,"onUpdate:modelValue":e[4]||(e[4]=n=>o.repertory=n),min:0,step:1},null,8,["modelValue"])]),_:1}),l(d,{label:"商品图片"},{default:a(()=>[l(k,{"list-type":"picture-card",limit:9,"auto-upload":!1,"file-list":o.fileList,"on-change":L,"on-remove":h},{file:a(({file:n})=>[l(P,{src:n.url,fit:"cover",style:{width:"100%",height:"100%"}},null,8,["src"])]),default:a(()=>[l(u,null,{default:a(()=>[l(_)]),_:1})]),_:1},8,["file-list"])]),_:1}),l(d,{label:"详情"},{default:a(()=>[l(t,{modelValue:o.detail,"onUpdate:modelValue":e[5]||(e[5]=n=>o.detail=n),type:"textarea",rows:4,placeholder:"请输入详情"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512),y("div",H,[l(g,{type:"primary",loading:c.value,onClick:F},{default:a(()=>[...e[6]||(e[6]=[V("提交",-1)])]),_:1},8,["loading"]),l(g,{onClick:f},{default:a(()=>[...e[7]||(e[7]=[V("重置",-1)])]),_:1})])]),_:1})])}}}),W=$(j,[["__scopeId","data-v-2fccf4a4"]]);export{W as default};
