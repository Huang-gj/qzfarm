import{a as P}from"./product-DbVt4hIS.js";import{b as N,S}from"./index-ehGYOv3s.js";import{t as H}from"./test-CeED8DGd.js";import{l as B,r as b,M as E,A as d,O as R,C as $,H as a,D as n,P as V,S as v,e as i}from"./.store-CUxRj2E2.js";import{_ as A}from"./_plugin-vue_export-helper-DlAUqK2U.js";const T={class:"land-add-container layout-pd"},O={class:"mt15"},j=B({__name:"resource-add",setup(q){const w=N(),y=b(),_=b(!1),l=E({land_name:"",land_tag:"",area:"",price:0,sale_status:0,sale_time:"",detail:"",fileList:[]}),f=()=>{l.land_name="",l.land_tag="",l.area="",l.price=0,l.sale_status=0,l.sale_time="",l.detail="",l.fileList=[]},I=()=>{const t=S.get("farmInfo");if(t)return t.farm_id||t.FarmID||t.farmId||null;const e=w.getUserInfo;return(e==null?void 0:e.farm_id)||(e==null?void 0:e.FarmID)||(e==null?void 0:e.farmId)||null},U=async(t,e,o)=>{const s=[];for(const m of o)if(m.raw){const c=H(m.raw,t,-1,e).then(u=>{console.log(`文件 ${m.name} 上传成功:`,u)}).catch(u=>{throw console.error(`文件 ${m.name} 上传失败:`,u),new Error(`文件 ${m.name} 上传失败`)});s.push(c)}await Promise.all(s)},h=(t,e)=>{l.fileList=e},k=(t,e)=>{l.fileList=e},C=()=>{var t,e;return(t=l.land_name)!=null&&t.trim()?(e=l.area)!=null&&e.trim()?l.price===null||l.price===void 0?(i.error("请填写价格"),!1):!0:(i.error("请填写面积"),!1):(i.error("请填写土地名称"),!1)},D=async()=>{if(!C())return;const t=I();if(!t){i.error("未找到农场信息，请先绑定农场");return}const e={product_type:2,farm_id:Number(t),good_id:0,land_id:0,land:{id:0,del_state:0,del_time:"",create_time:"",land_id:0,farm_id:Number(t),land_name:l.land_name,land_tag:l.land_tag,area:l.area,price:l.price,sale_status:l.sale_status,sale_time:l.sale_time||"",detail:l.detail,image_urls:[]},good:{id:0,del_state:0,del_time:"",create_time:"",good_id:0,good_tag:"",good_name:"",farm_id:Number(t),image_urls:[],price:0,units:"",repertory:0,detail:""}};try{_.value=!0,console.log("第一步：创建土地记录...",e);const o=await P(e);if(console.log("第一步成功，获取到的响应:",o),o.code===200||o.Code===200){if(o.land_id){console.log("第二步：上传土地图片，land_id:",o.land_id);try{l.fileList&&l.fileList.length>0&&(console.log("上传土地图片..."),await U(t,o.land_id,l.fileList)),i.success("土地创建并上传图片成功！")}catch(s){console.error("文件上传失败:",s),i.warning("土地创建成功，但部分图片上传失败")}}else console.warn("未获取到land_id，跳过文件上传"),i.success(o.msg||o.Msg||"新增成功");f()}else i.error(o.msg||o.Msg||"新增失败")}catch(o){console.error("新增失败:",o),i.error("新增失败")}finally{_.value=!1}};return(t,e)=>{const o=d("el-input"),s=d("el-form-item"),m=d("el-input-number"),c=d("el-switch"),u=d("el-date-picker"),L=d("ele-Plus"),M=d("el-icon"),Y=d("el-image"),x=d("el-upload"),p=d("el-card"),F=d("el-form"),g=d("el-button");return $(),R("div",T,[a(p,{shadow:"hover"},{default:n(()=>[e[9]||(e[9]=V("div",{class:"mb15"},"新增土地资源",-1)),a(F,{ref_key:"formRef",ref:y,"label-width":"110px"},{default:n(()=>[a(p,{class:"mb15",shadow:"never"},{default:n(()=>[a(s,{label:"土地名称"},{default:n(()=>[a(o,{modelValue:l.land_name,"onUpdate:modelValue":e[0]||(e[0]=r=>l.land_name=r),placeholder:"请输入",clearable:""},null,8,["modelValue"])]),_:1}),a(s,{label:"标签"},{default:n(()=>[a(o,{modelValue:l.land_tag,"onUpdate:modelValue":e[1]||(e[1]=r=>l.land_tag=r),placeholder:"",clearable:""},null,8,["modelValue"])]),_:1}),a(s,{label:"面积"},{default:n(()=>[a(o,{modelValue:l.area,"onUpdate:modelValue":e[2]||(e[2]=r=>l.area=r),placeholder:"请输入面积",clearable:""},null,8,["modelValue"])]),_:1}),a(s,{label:"价格"},{default:n(()=>[a(m,{modelValue:l.price,"onUpdate:modelValue":e[3]||(e[3]=r=>l.price=r),min:0,precision:2,step:.1},null,8,["modelValue"])]),_:1}),a(s,{label:"上架状态"},{default:n(()=>[a(c,{modelValue:l.sale_status,"onUpdate:modelValue":e[4]||(e[4]=r=>l.sale_status=r),"active-value":0,"inactive-value":1},null,8,["modelValue"])]),_:1}),a(s,{label:"租赁截止"},{default:n(()=>[a(u,{modelValue:l.sale_time,"onUpdate:modelValue":e[5]||(e[5]=r=>l.sale_time=r),type:"datetime",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss",placeholder:"请选择租赁截止时间",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),a(s,{label:"土地图片"},{default:n(()=>[a(x,{"list-type":"picture-card",limit:9,"auto-upload":!1,"file-list":l.fileList,"on-change":h,"on-remove":k},{file:n(({file:r})=>[a(Y,{src:r.url,fit:"cover",style:{width:"100%",height:"100%"}},null,8,["src"])]),default:n(()=>[a(M,null,{default:n(()=>[a(L)]),_:1})]),_:1},8,["file-list"])]),_:1}),a(s,{label:"详情"},{default:n(()=>[a(o,{modelValue:l.detail,"onUpdate:modelValue":e[6]||(e[6]=r=>l.detail=r),type:"textarea",rows:4,placeholder:"请输入详情"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512),V("div",O,[a(g,{type:"primary",loading:_.value,onClick:D},{default:n(()=>[...e[7]||(e[7]=[v("提交",-1)])]),_:1},8,["loading"]),a(g,{onClick:f},{default:n(()=>[...e[8]||(e[8]=[v("重置",-1)])]),_:1})])]),_:1})])}}}),W=A(j,[["__scopeId","data-v-4f3aa5cb"]]);export{W as default};
