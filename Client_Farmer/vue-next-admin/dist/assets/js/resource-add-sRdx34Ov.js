import{a as H}from"./product-CSXALFpi.js";import{g as O}from"./category-DFqjn7fw.js";import{b as Z,S as j}from"./index-DiaY0LpO.js";import{l as I,Z as q,r as f,M as G,w as J,A as s,O as C,C as g,H as l,D as a,P as y,$ as K,a0 as Q,B as W,S as c,e as i}from"./.store-DdqHRk86.js";import{t as X}from"./test-CgF-wiUS.js";import{_ as Y}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"product-add-container layout-pd"},oe={class:"mt5"},te={class:"mt15"},le=I({name:"productResourceAdd"}),re=I({...le,setup(ae){const L=Z(),U=q(),x=f(),_=f(!1),b=f([]),o=G({good_name:"",good_tag:"",price:0,units:"",repertory:0,detail:"",fileList:[]}),v=()=>{o.good_name="",o.good_tag="",o.price=0,o.units="",o.repertory=0,o.detail="",o.fileList=[]},h=async()=>{try{const t=await O({categoryType:1});t.code===200?b.value=t.category||[]:i.warning(t.msg||"获取类目列表失败")}catch(t){console.error("获取类目列表失败:",t),i.error("获取类目列表失败")}},F=()=>{U.push("/make/category/add")},P=()=>{const t=j.get("farmInfo");if(t)return t.farm_id||t.FarmID||t.farmId||null;const e=L.getUserInfo;return(e==null?void 0:e.farm_id)||(e==null?void 0:e.FarmID)||(e==null?void 0:e.farmId)||null},B=async(t,e,r)=>{const d=[];for(const m of r)if(m.raw){const p=X(m.raw,t,e,-1).then(u=>{console.log(`文件 ${m.name} 上传成功:`,u)}).catch(u=>{throw console.error(`文件 ${m.name} 上传失败:`,u),new Error(`文件 ${m.name} 上传失败`)});d.push(p)}await Promise.all(d)},N=(t,e)=>{o.fileList=e},S=(t,e)=>{o.fileList=e},M=()=>{var t,e;return(t=o.good_name)!=null&&t.trim()?o.price===null||o.price===void 0?(i.error("请填写价格"),!1):(e=o.units)!=null&&e.trim()?o.repertory===null||o.repertory===void 0?(i.error("请填写库存"),!1):!0:(i.error("请填写单位"),!1):(i.error("请填写商品名称"),!1)},R=async()=>{if(!M())return;const t=P();if(!t){i.error("未找到农场信息，请先绑定农场");return}const e={product_type:1,farm_id:Number(t),good_id:0,land_id:0,good:{id:0,del_state:0,del_time:"",create_time:"",good_id:0,farm_id:Number(t),good_name:o.good_name,good_tag:o.good_tag,price:o.price,units:o.units,repertory:o.repertory,detail:o.detail,image_urls:[]},land:{id:0,del_state:0,del_time:"",create_time:"",land_id:0,farm_id:Number(t),land_name:"",land_tag:"",area:"",image_urls:[],price:0,detail:"",sale_status:0,sale_time:""}};try{_.value=!0,console.log("第一步：创建商品记录...");const r=await H(e);if(r.code===200||r.Code===200){if(console.log("第一步成功，获取到的响应:",r),r.good_id){console.log("第二步：上传商品图片，good_id:",r.good_id);try{o.fileList&&o.fileList.length>0&&(console.log("上传商品图片..."),await B(t,r.good_id,o.fileList)),i.success("商品创建并上传图片成功！")}catch(d){console.error("文件上传失败:",d),i.warning("商品创建成功，但部分图片上传失败")}}else console.warn("未获取到good_id，跳过文件上传"),i.success(r.msg||r.Msg||"新增成功");v()}else i.error(r.msg||r.Msg||"新增失败")}catch(r){console.error("新增失败:",r),i.error("新增失败")}finally{_.value=!1}};return J(()=>{h()}),(t,e)=>{const r=s("el-input"),d=s("el-form-item"),m=s("el-option"),p=s("el-select"),u=s("el-link"),A=s("el-text"),V=s("el-input-number"),D=s("ele-Plus"),E=s("el-icon"),T=s("el-image"),$=s("el-upload"),w=s("el-card"),z=s("el-form"),k=s("el-button");return g(),C("div",ee,[l(w,{shadow:"hover"},{default:a(()=>[e[10]||(e[10]=y("div",{class:"mb15"},"新增农产品资源",-1)),l(z,{ref_key:"formRef",ref:x,"label-width":"110px"},{default:a(()=>[l(w,{class:"mb15",shadow:"never"},{default:a(()=>[l(d,{label:"商品名称"},{default:a(()=>[l(r,{modelValue:o.good_name,"onUpdate:modelValue":e[0]||(e[0]=n=>o.good_name=n),placeholder:"请输入",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{label:"商品类目"},{default:a(()=>[l(p,{modelValue:o.good_tag,"onUpdate:modelValue":e[1]||(e[1]=n=>o.good_tag=n),placeholder:"请选择商品类目",clearable:"",filterable:"",style:{width:"100%"}},{default:a(()=>[(g(!0),C(K,null,Q(b.value,n=>(g(),W(m,{key:n.category_id,label:n.name,value:n.name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),y("div",oe,[l(A,{size:"small",type:"info"},{default:a(()=>[e[7]||(e[7]=c(" 没有合适的类目？ ",-1)),l(u,{type:"primary",onClick:F},{default:a(()=>[...e[6]||(e[6]=[c("点击新增类目",-1)])]),_:1})]),_:1})])]),_:1}),l(d,{label:"价格"},{default:a(()=>[l(V,{modelValue:o.price,"onUpdate:modelValue":e[2]||(e[2]=n=>o.price=n),min:0,precision:2,step:.1},null,8,["modelValue"])]),_:1}),l(d,{label:"单位"},{default:a(()=>[l(r,{modelValue:o.units,"onUpdate:modelValue":e[3]||(e[3]=n=>o.units=n),placeholder:"个/斤/千克等",clearable:""},null,8,["modelValue"])]),_:1}),l(d,{label:"库存"},{default:a(()=>[l(V,{modelValue:o.repertory,"onUpdate:modelValue":e[4]||(e[4]=n=>o.repertory=n),min:0,step:1},null,8,["modelValue"])]),_:1}),l(d,{label:"商品图片"},{default:a(()=>[l($,{"list-type":"picture-card",limit:9,"auto-upload":!1,"file-list":o.fileList,"on-change":N,"on-remove":S},{file:a(({file:n})=>[l(T,{src:n.url,fit:"cover",style:{width:"100%",height:"100%"}},null,8,["src"])]),default:a(()=>[l(E,null,{default:a(()=>[l(D)]),_:1})]),_:1},8,["file-list"])]),_:1}),l(d,{label:"详情"},{default:a(()=>[l(r,{modelValue:o.detail,"onUpdate:modelValue":e[5]||(e[5]=n=>o.detail=n),type:"textarea",rows:4,placeholder:"请输入详情"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},512),y("div",te,[l(k,{type:"primary",loading:_.value,onClick:R},{default:a(()=>[...e[8]||(e[8]=[c("提交",-1)])]),_:1},8,["loading"]),l(k,{onClick:v},{default:a(()=>[...e[9]||(e[9]=[c("重置",-1)])]),_:1})])]),_:1})])}}}),ce=Y(re,[["__scopeId","data-v-e22bd385"]]);export{ce as default};
