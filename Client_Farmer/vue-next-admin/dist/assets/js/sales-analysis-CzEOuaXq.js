import{l as N,r as B,M as U,y as L,w as P,n as V,A as _,a5 as j,O as F,C as D,P as a,H as i,D as n,S as y,$ as H,a0 as W,B as z,T as f,F as q,e as S,a2 as J}from"./.store-DdqHRk86.js";import{b as K,S as Q}from"./index-mLlbfZu9.js";import{b as X}from"./farm-CWn68x6C.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"sales-analysis-container layout-pd"},te={class:"time-selector mb15"},ae={class:"time-buttons"},oe={class:"time-info"},se={class:"card-content"},le={class:"card-info"},ne={class:"card-value"},re={class:"card-content"},ie={class:"card-info"},de={class:"card-value"},ce={class:"card-content"},pe={class:"card-info"},ge={class:"card-value"},ve={class:"card-content"},ue={class:"card-info"},me={class:"card-value"},_e={class:"pagination-container"},fe=N({name:"salesAnalysis"}),we=N({...fe,setup(ye){const G=K(),x=B(),e=U({activeTimeType:"year",selectedTime:"",timeOptions:[],loading:!1,overview:{totalSales:0,avgDailySales:0,goodSales:0,landSales:0,ordersGrowth:"",salesGrowth:"",avgGrowth:"",daysGrowth:""},tableData:[],allData:[],pagination:{page:1,size:20,total:0},chart:null}),A=()=>{const o=G.getUserInfo,t=Q.get("farmInfo");let s=0;return t!=null&&t.farm_id?s=t.farm_id:o!=null&&o.farm_id&&(s=o.farm_id),s},h=(o,t)=>{if(t===0)return o>0?'环比增长率：<span style="color: #F56C6C;">+∞%</span>':'环比增长率：<span style="color: #909399;">0%</span>';const s=(o/t-1)*100,l=Math.abs(s).toFixed(1);return s>0?`环比增长率：<span style="color: #F56C6C;">+${l}%</span>`:s<0?`环比增长率：<span style="color: #67C23A;">-${l}%</span>`:'环比增长率：<span style="color: #909399;">0%</span>'},k=o=>{const s=new Date().getFullYear(),l=[];switch(o){case"year":for(let g=2025;g<=s;g++)l.push({value:g.toString(),label:`${g}年`});break;case"month":for(let g=1;g<=12;g++){const u=g.toString().padStart(2,"0");l.push({value:`${s}-${u}`,label:`${s}年${g}月`})}break;case"week":const r=new Date(s,0,1);let d=new Date(r);for(;d.getDay()!==1;)d.setDate(d.getDate()-1);let p=1;const m=52;for(;p<=m;){const g=new Date(d),u=new Date(d);if(u.setDate(g.getDate()+6),u.getFullYear()>s)break;const w=`${g.getFullYear()}-${(g.getMonth()+1).toString().padStart(2,"0")}-${g.getDate().toString().padStart(2,"0")}`,c=`${u.getFullYear()}-${(u.getMonth()+1).toString().padStart(2,"0")}-${u.getDate().toString().padStart(2,"0")}`;l.push({value:`${w}|${c}`,label:`${g.getMonth()+1}月${g.getDate()}日-${u.getMonth()+1}月${u.getDate()}日（第${p}周）`}),d.setDate(d.getDate()+7),p++}break}return l},O=(o,t)=>{let s="",l="";try{switch(o){case"year":const v=parseInt(t);if(isNaN(v))throw new Error("年份格式无效");s=`${v}-01-01`,l=`${v}-12-31`;break;case"month":const[r,d]=t.split("-"),p=parseInt(r),m=parseInt(d);if(isNaN(p)||isNaN(m))throw new Error("月份格式无效");s=`${p}-${d}-01`;const g=new Date(p,m,0).getDate();l=`${p}-${d}-${g.toString().padStart(2,"0")}`;break;case"week":if(!t||!t.includes("|"))throw new Error("周格式无效");const[u,w]=t.split("|");if(!u||!w)throw new Error("周日期范围无效");s=u,l=w;break;default:throw new Error("未知的时间类型")}}catch(v){console.error("时间范围计算错误:",v);const r=new Date,d=r.getFullYear(),p=(r.getMonth()+1).toString().padStart(2,"0"),m=r.getDate().toString().padStart(2,"0");s=`${d}-${p}-${m}`,l=`${d}-${p}-${m}`}return{startDate:s,endDate:l}},$=async()=>{try{e.loading=!0;const o=A();if(!o){S.error("未找到农场信息，请先绑定农场");return}if(!e.selectedTime){S.error("请选择查看时间");return}const t=O(e.activeTimeType,e.selectedTime);if(!t.startDate||!t.endDate){S.error("时间范围计算错误，请重新选择");return}const s={farm_id:o,start_date:t.startDate,end_date:t.endDate},l=await X(s);if(l.code===200){const v=e.allData;e.allData=l.sale_data||[],E(v),b(),C()}else S.error(`获取数据失败: ${l.msg}`)}catch(o){console.error("获取销售数据失败:",o),S.error("获取数据失败，请稍后重试")}finally{e.loading=!1}},E=(o=[])=>{const t=e.allData;if(e.overview.goodSales=t.reduce((s,l)=>s+l.good_sale_count,0),e.overview.landSales=t.reduce((s,l)=>s+l.land_sale_count,0),e.overview.totalSales=e.overview.goodSales+e.overview.landSales,e.overview.avgDailySales=t.length>0?e.overview.totalSales/t.length:0,o.length>0){const s=o.reduce((d,p)=>d+p.good_sale_count,0),l=o.reduce((d,p)=>d+p.land_sale_count,0),v=s+l,r=o.length>0?v/o.length:0;e.overview.ordersGrowth=h(e.overview.totalSales,v),e.overview.salesGrowth=h(e.overview.avgDailySales,r),e.overview.avgGrowth=h(e.overview.goodSales,s),e.overview.daysGrowth=h(e.overview.landSales,l)}else e.overview.ordersGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.salesGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.avgGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.daysGrowth='环比增长率：<span style="color: #909399;">N/A</span>'},b=()=>{const o=(e.pagination.page-1)*e.pagination.size,t=o+e.pagination.size;e.tableData=e.allData.slice(o,t),e.pagination.total=e.allData.length},I=()=>{x.value&&(e.chart=J(x.value),C())},C=()=>{if(!e.chart)return;const o=e.allData.map(r=>r.stat_date),t=e.allData.map(r=>r.good_sale_count),s=e.allData.map(r=>r.land_sale_count),l=e.allData.map(r=>r.good_sale_count+r.land_sale_count),v={title:{text:"销售额趋势分析",left:"center",textStyle:{fontSize:16}},tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["农产品销售额","土地销售额","总销售额"],top:30},grid:{top:70,left:50,right:50,bottom:50},xAxis:{type:"category",data:o,axisLabel:{rotate:45,fontSize:10}},yAxis:{type:"value",name:"销售额",axisLabel:{formatter:"¥{value}"}},series:[{name:"农产品销售额",type:"bar",data:t,itemStyle:{color:"#67C23A"}},{name:"土地销售额",type:"bar",data:s,itemStyle:{color:"#E6A23C"}},{name:"总销售额",type:"line",data:l,smooth:!0,itemStyle:{color:"#409EFF"},lineStyle:{color:"#409EFF"}}]};e.chart.setOption(v)},T=o=>{e.activeTimeType=o,e.timeOptions=k(o),e.timeOptions.length>0&&(e.selectedTime=e.timeOptions[0].value),e.pagination.page=1,$()},M=()=>{e.pagination.page=1,$()},Y=o=>{e.pagination.size=o,e.pagination.page=1,b()},R=o=>{e.pagination.page=o,b()};return L(()=>e.allData,()=>{b()}),P(()=>{e.timeOptions=k(e.activeTimeType),e.timeOptions.length>0&&(e.selectedTime=e.timeOptions[0].value),V(()=>{I(),$()})}),(o,t)=>{const s=_("el-button"),l=_("el-option"),v=_("el-select"),r=_("el-card"),d=_("el-col"),p=_("el-row"),m=_("el-table-column"),g=_("el-table"),u=_("el-pagination"),w=j("loading");return D(),F("div",ee,[t[20]||(t[20]=a("div",{class:"page-header mb15"},[a("h2",null,"销售额分析"),a("p",null,"查看农场销售总额的详细统计和趋势分析")],-1)),a("div",te,[i(r,{class:"time-selector-card"},{default:n(()=>[a("div",ae,[i(s,{type:e.activeTimeType==="year"?"primary":"default",onClick:t[0]||(t[0]=c=>T("year")),size:"large"},{default:n(()=>[...t[6]||(t[6]=[y(" 年总结 ",-1)])]),_:1},8,["type"]),i(s,{type:e.activeTimeType==="month"?"primary":"default",onClick:t[1]||(t[1]=c=>T("month")),size:"large"},{default:n(()=>[...t[7]||(t[7]=[y(" 月总结 ",-1)])]),_:1},8,["type"]),i(s,{type:e.activeTimeType==="week"?"primary":"default",onClick:t[2]||(t[2]=c=>T("week")),size:"large"},{default:n(()=>[...t[8]||(t[8]=[y(" 周总结 ",-1)])]),_:1},8,["type"])]),a("div",oe,[t[9]||(t[9]=a("span",{class:"time-label"},"当前查看：",-1)),i(v,{modelValue:e.selectedTime,"onUpdate:modelValue":t[3]||(t[3]=c=>e.selectedTime=c),onChange:M,style:{width:"200px"},placeholder:"请选择时间"},{default:n(()=>[(D(!0),F(H,null,W(e.timeOptions,c=>(D(),z(l,{key:c.value,label:c.label,value:c.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),_:1})]),i(p,{gutter:15,class:"overview-cards mb15"},{default:n(()=>[i(d,{xs:24,sm:12,md:12,xl:12},{default:n(()=>[i(r,{class:"overview-card"},{default:n(()=>[a("div",se,[t[11]||(t[11]=a("div",{class:"card-icon",style:{background:"var(--next-color-success-lighter)"}},[a("i",{class:"fa fa-dollar",style:{color:"var(--el-color-success)"}})],-1)),a("div",le,[a("div",ne,"¥"+f(e.overview.totalSales.toFixed(2)),1),t[10]||(t[10]=a("div",{class:"card-label"},"总销售额",-1))])])]),_:1})]),_:1}),i(d,{xs:24,sm:12,md:12,xl:12},{default:n(()=>[i(r,{class:"overview-card"},{default:n(()=>[a("div",re,[t[13]||(t[13]=a("div",{class:"card-icon",style:{background:"var(--next-color-primary-lighter)"}},[a("i",{class:"fa fa-dollar",style:{color:"var(--el-color-primary)","font-size":"1.5em"}})],-1)),a("div",ie,[a("div",de,"¥"+f(e.overview.avgDailySales.toFixed(2)),1),t[12]||(t[12]=a("div",{class:"card-label"},"日均销售额",-1))])])]),_:1})]),_:1})]),_:1}),i(p,{gutter:15,class:"overview-cards mb15"},{default:n(()=>[i(d,{xs:24,sm:12,md:12,xl:12},{default:n(()=>[i(r,{class:"overview-card"},{default:n(()=>[a("div",ce,[t[15]||(t[15]=a("div",{class:"card-icon",style:{background:"var(--next-color-warning-lighter)"}},[a("i",{class:"fa fa-dollar",style:{color:"var(--el-color-warning)"}})],-1)),a("div",pe,[a("div",ge,"¥"+f(e.overview.goodSales.toFixed(2)),1),t[14]||(t[14]=a("div",{class:"card-label"},"农产品销售额",-1))])])]),_:1})]),_:1}),i(d,{xs:24,sm:12,md:12,xl:12},{default:n(()=>[i(r,{class:"overview-card"},{default:n(()=>[a("div",ve,[t[17]||(t[17]=a("div",{class:"card-icon",style:{background:"var(--next-color-danger-lighter)"}},[a("i",{class:"fa fa-dollar",style:{color:"var(--el-color-danger)"}})],-1)),a("div",ue,[a("div",me,"¥"+f(e.overview.landSales.toFixed(2)),1),t[16]||(t[16]=a("div",{class:"card-label"},"土地租赁销售额",-1))])])]),_:1})]),_:1})]),_:1}),i(p,{class:"mb15"},{default:n(()=>[i(d,{span:24},{default:n(()=>[i(r,{class:"chart-card"},{header:n(()=>[...t[18]||(t[18]=[a("div",{class:"card-header"},[a("span",null,"销售额趋势图表")],-1)])]),default:n(()=>[a("div",{ref_key:"chartRef",ref:x,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1}),i(p,null,{default:n(()=>[i(d,{span:24},{default:n(()=>[i(r,{class:"table-card"},{header:n(()=>[...t[19]||(t[19]=[a("div",{class:"card-header"},[a("span",null,"详细数据列表")],-1)])]),default:n(()=>[q((D(),z(g,{data:e.tableData,style:{width:"100%"},"max-height":"320"},{default:n(()=>[i(m,{prop:"stat_date",label:"日期",width:"100"}),i(m,{prop:"good_sale_count",label:"农产品销售额",align:"center"},{default:n(c=>[y(" ¥"+f(c.row.good_sale_count.toFixed(2)),1)]),_:1}),i(m,{prop:"land_sale_count",label:"土地销售额",align:"center"},{default:n(c=>[y(" ¥"+f(c.row.land_sale_count.toFixed(2)),1)]),_:1}),i(m,{label:"总销售额",align:"center"},{default:n(c=>[y(" ¥"+f((c.row.good_sale_count+c.row.land_sale_count).toFixed(2)),1)]),_:1})]),_:1},8,["data"])),[[w,e.loading]]),a("div",_e,[i(u,{"current-page":e.pagination.page,"onUpdate:currentPage":t[4]||(t[4]=c=>e.pagination.page=c),"page-size":e.pagination.size,"onUpdate:pageSize":t[5]||(t[5]=c=>e.pagination.size=c),"page-sizes":[10,20,50,100],total:e.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:Y,onCurrentChange:R},null,8,["current-page","page-size","total"])])]),_:1})]),_:1})]),_:1})])}}}),xe=Z(we,[["__scopeId","data-v-4aaac3a3"]]);export{xe as default};
