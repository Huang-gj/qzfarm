import{l as N,r as R,M as B,y as L,w as P,n as V,A as f,a5 as j,O as U,C as b,P as a,H as n,D as l,S as x,$ as H,a0 as W,B as z,T as w,F as q,e as _,a2 as J}from"./.store-DdqHRk86.js";import{b as K,S as Q}from"./index-mLlbfZu9.js";import{b as X}from"./farm-CWn68x6C.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ee={class:"user-analysis-container layout-pd"},te={class:"time-selector mb15"},ae={class:"time-buttons"},se={class:"time-info"},re={class:"card-content"},oe={class:"card-info"},ne={class:"card-value"},le={class:"card-content"},ie={class:"card-info"},ce={class:"card-value"},de={class:"card-content"},pe={class:"card-info"},ue={class:"card-value"},ve={class:"card-content"},ge={class:"card-info"},me={class:"card-value"},fe={class:"pagination-container"},ye=N({name:"userAnalysis"}),we=N({...ye,setup(_e){const A=K(),S=R(),e=B({activeTimeType:"year",selectedTime:"",timeOptions:[],loading:!1,overview:{totalUsers:0,avgDailyUsers:0,maxUsers:0,activeDays:0,ordersGrowth:"",salesGrowth:"",avgGrowth:"",daysGrowth:""},tableData:[],allData:[],pagination:{page:1,size:20,total:0},chart:null}),F=()=>{const o=A.getUserInfo,t=Q.get("farmInfo");let r=0;return t!=null&&t.farm_id?r=t.farm_id:o!=null&&o.farm_id&&(r=o.farm_id),r},h=(o,t)=>{if(t===0)return o>0?'环比增长率：<span style="color: #F56C6C;">+∞%</span>':'环比增长率：<span style="color: #909399;">0%</span>';const r=(o/t-1)*100,s=Math.abs(r).toFixed(1);return r>0?`环比增长率：<span style="color: #F56C6C;">+${s}%</span>`:r<0?`环比增长率：<span style="color: #67C23A;">-${s}%</span>`:'环比增长率：<span style="color: #909399;">0%</span>'},k=o=>{const r=new Date().getFullYear(),s=[];switch(o){case"year":for(let i=2025;i<=r;i++)s.push({value:i.toString(),label:`${i}年`});break;case"month":for(let i=1;i<=12;i++){const m=i.toString().padStart(2,"0");s.push({value:`${r}-${m}`,label:`${r}年${i}月`})}break;case"week":const v=new Date(r,0,1);let d=new Date(v);for(;d.getDay()!==1;)d.setDate(d.getDate()-1);let u=1;const p=52;for(;u<=p;){const i=new Date(d),m=new Date(d);if(m.setDate(i.getDate()+6),m.getFullYear()>r)break;const y=`${i.getFullYear()}-${(i.getMonth()+1).toString().padStart(2,"0")}-${i.getDate().toString().padStart(2,"0")}`,g=`${m.getFullYear()}-${(m.getMonth()+1).toString().padStart(2,"0")}-${m.getDate().toString().padStart(2,"0")}`;s.push({value:`${y}|${g}`,label:`${i.getMonth()+1}月${i.getDate()}日-${m.getMonth()+1}月${m.getDate()}日（第${u}周）`}),d.setDate(d.getDate()+7),u++}break}return s},M=(o,t)=>{let r="",s="";try{switch(o){case"year":const c=parseInt(t);if(isNaN(c))throw new Error("年份格式无效");r=`${c}-01-01`,s=`${c}-12-31`;break;case"month":const[v,d]=t.split("-"),u=parseInt(v),p=parseInt(d);if(isNaN(u)||isNaN(p))throw new Error("月份格式无效");r=`${u}-${d}-01`;const i=new Date(u,p,0).getDate();s=`${u}-${d}-${i.toString().padStart(2,"0")}`;break;case"week":if(!t||!t.includes("|"))throw new Error("周格式无效");const[m,y]=t.split("|");if(!m||!y)throw new Error("周日期范围无效");r=m,s=y;break;default:throw new Error("未知的时间类型")}}catch(c){console.error("时间范围计算错误:",c);const v=new Date,d=v.getFullYear(),u=(v.getMonth()+1).toString().padStart(2,"0"),p=v.getDate().toString().padStart(2,"0");r=`${d}-${u}-${p}`,s=`${d}-${u}-${p}`}return{startDate:r,endDate:s}},$=async()=>{try{e.loading=!0;const o=F();if(!o){_.error("未找到农场信息，请先绑定农场");return}if(!e.selectedTime){_.error("请选择查看时间");return}const t=M(e.activeTimeType,e.selectedTime);if(!t.startDate||!t.endDate){_.error("时间范围计算错误，请重新选择");return}const r={farm_id:o,start_date:t.startDate,end_date:t.endDate},s=await X(r);if(s.code===200){const c=e.allData;e.allData=s.sale_data||[],O(c),D(),C()}else _.error(`获取数据失败: ${s.msg}`)}catch(o){console.error("获取销售数据失败:",o),_.error("获取数据失败，请稍后重试")}finally{e.loading=!1}},O=(o=[])=>{const r=e.allData.map(s=>s.sys_use_count).filter(s=>s>0);if(e.overview.totalUsers=r.reduce((s,c)=>Math.max(s,c),0),e.overview.avgDailyUsers=r.length>0?r.reduce((s,c)=>s+c,0)/r.length:0,e.overview.maxUsers=Math.max(...r,0),e.overview.activeDays=r.length,o.length>0){const s=o.map(p=>p.sys_use_count).filter(p=>p>0),c=s.reduce((p,i)=>Math.max(p,i),0),v=s.length>0?s.reduce((p,i)=>p+i,0)/s.length:0,d=Math.max(...s,0),u=s.length;e.overview.ordersGrowth=h(e.overview.totalUsers,c),e.overview.salesGrowth=h(e.overview.avgDailyUsers,v),e.overview.avgGrowth=h(e.overview.maxUsers,d),e.overview.daysGrowth=h(e.overview.activeDays,u)}else e.overview.ordersGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.salesGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.avgGrowth='环比增长率：<span style="color: #909399;">N/A</span>',e.overview.daysGrowth='环比增长率：<span style="color: #909399;">N/A</span>'},D=()=>{const o=(e.pagination.page-1)*e.pagination.size,t=o+e.pagination.size;e.tableData=e.allData.slice(o,t),e.pagination.total=e.allData.length},G=()=>{S.value&&(e.chart=J(S.value),C())},C=()=>{if(!e.chart)return;const o=e.allData.map(c=>c.stat_date),t=e.allData.map(c=>c.sys_use_count),r=e.allData.map(c=>c.good_order_count+c.land_order_count),s={title:{text:"用户活跃度趋势分析",left:"center",textStyle:{fontSize:16}},tooltip:{trigger:"axis",axisPointer:{type:"cross"}},legend:{data:["使用人数","订单总数"],top:30},grid:{top:70,left:50,right:50,bottom:50},xAxis:{type:"category",data:o,axisLabel:{rotate:45,fontSize:10}},yAxis:[{type:"value",name:"使用人数",position:"left",axisLabel:{formatter:"{value}人"}},{type:"value",name:"订单数",position:"right",axisLabel:{formatter:"{value}"}}],series:[{name:"使用人数",type:"line",yAxisIndex:0,data:t,smooth:!0,itemStyle:{color:"#409EFF"},lineStyle:{color:"#409EFF"},areaStyle:{color:"rgba(64, 158, 255, 0.1)"}},{name:"订单总数",type:"bar",yAxisIndex:1,data:r,itemStyle:{color:"#67C23A"}}]};e.chart.setOption(s)},T=o=>{e.activeTimeType=o,e.timeOptions=k(o),e.timeOptions.length>0&&(e.selectedTime=e.timeOptions[0].value),e.pagination.page=1,$()},E=()=>{e.pagination.page=1,$()},I=o=>{e.pagination.size=o,e.pagination.page=1,D()},Y=o=>{e.pagination.page=o,D()};return L(()=>e.allData,()=>{D()}),P(()=>{e.timeOptions=k(e.activeTimeType),e.timeOptions.length>0&&(e.selectedTime=e.timeOptions[0].value),V(()=>{G(),$()})}),(o,t)=>{const r=f("el-button"),s=f("el-option"),c=f("el-select"),v=f("el-card"),d=f("el-col"),u=f("el-row"),p=f("el-table-column"),i=f("el-table"),m=f("el-pagination"),y=j("loading");return b(),U("div",ee,[t[20]||(t[20]=a("div",{class:"page-header mb15"},[a("h2",null,"系统使用人数分析"),a("p",null,"查看系统用户活跃度的详细统计和趋势分析")],-1)),a("div",te,[n(v,{class:"time-selector-card"},{default:l(()=>[a("div",ae,[n(r,{type:e.activeTimeType==="year"?"primary":"default",onClick:t[0]||(t[0]=g=>T("year")),size:"large"},{default:l(()=>[...t[6]||(t[6]=[x(" 年总结 ",-1)])]),_:1},8,["type"]),n(r,{type:e.activeTimeType==="month"?"primary":"default",onClick:t[1]||(t[1]=g=>T("month")),size:"large"},{default:l(()=>[...t[7]||(t[7]=[x(" 月总结 ",-1)])]),_:1},8,["type"]),n(r,{type:e.activeTimeType==="week"?"primary":"default",onClick:t[2]||(t[2]=g=>T("week")),size:"large"},{default:l(()=>[...t[8]||(t[8]=[x(" 周总结 ",-1)])]),_:1},8,["type"])]),a("div",se,[t[9]||(t[9]=a("span",{class:"time-label"},"当前查看：",-1)),n(c,{modelValue:e.selectedTime,"onUpdate:modelValue":t[3]||(t[3]=g=>e.selectedTime=g),onChange:E,style:{width:"200px"},placeholder:"请选择时间"},{default:l(()=>[(b(!0),U(H,null,W(e.timeOptions,g=>(b(),z(s,{key:g.value,label:g.label,value:g.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),_:1})]),n(u,{gutter:15,class:"overview-cards mb15"},{default:l(()=>[n(d,{xs:24,sm:12,md:12,xl:12},{default:l(()=>[n(v,{class:"overview-card"},{default:l(()=>[a("div",re,[t[11]||(t[11]=a("div",{class:"card-icon",style:{background:"var(--next-color-primary-lighter)"}},[a("i",{class:"fa fa-users",style:{color:"var(--el-color-primary)"}})],-1)),a("div",oe,[a("div",ne,w(e.overview.totalUsers),1),t[10]||(t[10]=a("div",{class:"card-label"},"总使用人数",-1))])])]),_:1})]),_:1}),n(d,{xs:24,sm:12,md:12,xl:12},{default:l(()=>[n(v,{class:"overview-card"},{default:l(()=>[a("div",le,[t[13]||(t[13]=a("div",{class:"card-icon",style:{background:"var(--next-color-success-lighter)"}},[a("i",{class:"fa fa-user",style:{color:"var(--el-color-success)"}})],-1)),a("div",ie,[a("div",ce,w(e.overview.avgDailyUsers.toFixed(0)),1),t[12]||(t[12]=a("div",{class:"card-label"},"日均活跃用户",-1))])])]),_:1})]),_:1})]),_:1}),n(u,{gutter:15,class:"overview-cards mb15"},{default:l(()=>[n(d,{xs:24,sm:12,md:12,xl:12},{default:l(()=>[n(v,{class:"overview-card"},{default:l(()=>[a("div",de,[t[15]||(t[15]=a("div",{class:"card-icon",style:{background:"var(--next-color-warning-lighter)"}},[a("i",{class:"fa fa-user-plus",style:{color:"var(--el-color-warning)"}})],-1)),a("div",pe,[a("div",ue,w(e.overview.maxUsers),1),t[14]||(t[14]=a("div",{class:"card-label"},"峰值使用人数",-1))])])]),_:1})]),_:1}),n(d,{xs:24,sm:12,md:12,xl:12},{default:l(()=>[n(v,{class:"overview-card"},{default:l(()=>[a("div",ve,[t[17]||(t[17]=a("div",{class:"card-icon",style:{background:"var(--next-color-danger-lighter)"}},[a("i",{class:"fa fa-calendar",style:{color:"var(--el-color-danger)"}})],-1)),a("div",ge,[a("div",me,w(e.overview.activeDays),1),t[16]||(t[16]=a("div",{class:"card-label"},"活跃天数",-1))])])]),_:1})]),_:1})]),_:1}),n(u,{class:"mb15"},{default:l(()=>[n(d,{span:24},{default:l(()=>[n(v,{class:"chart-card"},{header:l(()=>[...t[18]||(t[18]=[a("div",{class:"card-header"},[a("span",null,"用户活跃度趋势图表")],-1)])]),default:l(()=>[a("div",{ref_key:"chartRef",ref:S,class:"chart-container"},null,512)]),_:1})]),_:1})]),_:1}),n(u,null,{default:l(()=>[n(d,{span:24},{default:l(()=>[n(v,{class:"table-card"},{header:l(()=>[...t[19]||(t[19]=[a("div",{class:"card-header"},[a("span",null,"详细数据列表")],-1)])]),default:l(()=>[q((b(),z(i,{data:e.tableData,style:{width:"100%"},"max-height":"320"},{default:l(()=>[n(p,{prop:"stat_date",label:"日期",width:"100"}),n(p,{prop:"sys_use_count",label:"使用人数",width:"100",align:"center"}),n(p,{prop:"good_order_count",label:"农产品订单数",width:"120",align:"center"}),n(p,{prop:"land_order_count",label:"土地订单数",width:"120",align:"center"}),n(p,{label:"总订单数",align:"center"},{default:l(g=>[x(w(g.row.good_order_count+g.row.land_order_count),1)]),_:1})]),_:1},8,["data"])),[[y,e.loading]]),a("div",fe,[n(m,{"current-page":e.pagination.page,"onUpdate:currentPage":t[4]||(t[4]=g=>e.pagination.page=g),"page-size":e.pagination.size,"onUpdate:pageSize":t[5]||(t[5]=g=>e.pagination.size=g),"page-sizes":[10,20,50,100],total:e.pagination.total,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:I,onCurrentChange:Y},null,8,["current-page","page-size","total"])])]),_:1})]),_:1})]),_:1})])}}}),Se=Z(we,[["__scopeId","data-v-6c7b0da8"]]);export{Se as default};
